<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ—¥æ¬¡ äººä»¶è²»ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆBASE Jï¼‰</title>
<style>
/* ===== BASE I æ—¢å­˜ ===== */
body { font-family: "Segoe UI", sans-serif; background:#f4f6f8; padding:20px; }
.box { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
input, select { padding:6px; margin:4px; }
button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
.add-btn { background:#3498db; color:#fff; }
.calc-btn { background:#2ecc71; color:#fff; font-size:16px; }
.pattern-btn { background:#9b59b6; color:#fff; }
.delete-btn { background:#e74c3c; color:#fff; }
.row-delete { background:#c0392b; color:#fff; }
.reset-btn { background:#555; color:#fff; margin-left:10px; }
table { border-collapse: collapse; width:100%; }
th,td { padding:6px; border:1px solid #ccc; text-align:center; }
th { background:#eee; }
.result { font-size:18px; font-weight:bold; }
.good { color:#2ecc71; }
.bad { color:#e74c3c; }
.restInput { width:70px; text-align:center; }
.restBtn { width:28px; height:28px; padding:0; margin:0 0 0 4px; border-radius:6px; background:#777; color:#fff; font-weight:bold; line-height:28px; }
.restBtn:hover { filter:brightness(1.1); }
.restWrap { display:inline-flex; align-items:center; justify-content:center; gap:4px; }
.restBtnCol { display:flex; flex-direction:column; gap:4px; }

/* å£²ä¸ŠÂ±10ä¸‡ãƒœã‚¿ãƒ³ */
.salesBtn { background:#777; color:#fff; border-radius:6px; padding:6px 10px; margin-left:6px; }
.salesBtn:hover { filter:brightness(1.1); }

/* ===== äºˆç´„ã‚«ã‚¦ãƒ³ãƒˆï¼ˆçµ±åˆéƒ¨ï¼‰ ===== */
.row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.small { font-size: 12px; color:#555; }
.right { text-align:right; }
.left { text-align:left; }
.nowrap { white-space:nowrap; }
.muted-btn { background:#666; color:#fff; }
.ok-btn { background:#2ecc71; color:#fff; }
.warn { color:#e74c3c; font-weight:bold; }
hr.sep { border:none; border-top:1px solid #ddd; margin:12px 0; }
</style>
</head>
<body>

<h1>ğŸ“Š æ—¥æ¬¡ äººä»¶è²»ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>

<div class="box">
è¦‹è¾¼ã¿å£²ä¸Šï¼š
<input type="number" id="sales" value="0"> å††
<button type="button" class="salesBtn" onclick="adjustSales(100000)">ï¼‹10ä¸‡</button>
<button type="button" class="salesBtn" onclick="adjustSales(-100000)">ï¼10ä¸‡</button>
ã€€
å…±é€šæ™‚çµ¦ï¼š
<input type="number" id="wage" value="1200" onchange="saveWage()"> å††
<br>
ç¤¾å“¡ï¼ˆãƒ›ãƒ¼ãƒ«ï¼‰ï¼š
<input type="number" id="staffHall" value="0"> äººã€€
ç¤¾å“¡ï¼ˆã‚­ãƒƒãƒãƒ³ï¼‰ï¼š
<input type="number" id="staffKitchen" value="0"> äººã€€
ï¼ˆå„ Ã—16,500å††ï¼‰
<br>
ğŸ¯ ç›®æ¨™äººä»¶è²»ç‡ï¼š
<input type="number" id="targetRate" value="25" step="0.1" onchange="saveTargetRate()"> %
</div>

<!-- ===== äºˆç´„ã‚«ã‚¦ãƒ³ãƒˆï¼ˆçµ±åˆï¼‰ ===== -->
<div class="box">
  <h3>ğŸ§¾ äºˆç´„ã‚«ã‚¦ãƒ³ãƒˆï¼ˆè¦‹è¾¼ã¿å£²ä¸Šã®å†…è¨³ï¼‰</h3>

  <div class="row">
    å¸­ã®ã¿ è¦‹è¾¼ã¿å®¢å˜ä¾¡ï¼š
    <input type="number" id="rc_seatUnit" value="4000" step="1"> å†† / äºº
    <button class="ok-btn" type="button" onclick="rc_saveSeatUnit()">ä¿å­˜</button>

    <button class="pattern-btn" type="button" onclick="rc_applyTotalToSales()">â†ª äºˆç´„åˆè¨ˆã‚’è¦‹è¾¼ã¿å£²ä¸Šã¸åæ˜ </button>

    <label class="small">
      <input type="checkbox" id="rc_autoApply" onchange="rc_onToggleAutoApply()">
      è‡ªå‹•åæ˜ 
    </label>
  </div>

  <div class="small">
    â€»ã“ã“ã¯ã€Œè¦‹è¾¼ã¿å£²ä¸Šã®ä½œæˆè£œåŠ©ã€ã€‚BASE H ã®è¨ˆç®—è‡ªä½“ã¯å¾“æ¥ã©ãŠã‚Šè¦‹è¾¼ã¿å£²ä¸Šæ¬„ã‚’å‚ç…§ï¼ˆæ‰‹å…¥åŠ›ã‚‚OKï¼‰ã€‚
  </div>

  <hr class="sep">

  <h3>â‘  ã‚³ãƒ¼ã‚¹ç™»éŒ²ï¼ˆä¿å­˜ï¼‰</h3>
  <div class="row">
    ã‚³ãƒ¼ã‚¹å <input id="rc_courseName" placeholder="ä¾‹ï¼šé£²ã¿æ”¾é¡Œä»˜ãã‚³ãƒ¼ã‚¹">
    é‡‘é¡ <input type="number" id="rc_coursePrice" placeholder="ä¾‹ï¼š5500"> å†† / äºº
    <button class="add-btn" type="button" onclick="rc_addCourse()">è¿½åŠ </button>
    <button class="muted-btn" type="button" onclick="rc_clearAllCourses()">ğŸ—‘ ã‚³ãƒ¼ã‚¹ä¸€æ‹¬å‰Šé™¤</button>
  </div>

  <table id="rc_courseTable">
    <tr>
      <th>ã‚³ãƒ¼ã‚¹å</th>
      <th>é‡‘é¡ï¼ˆå††/äººï¼‰</th>
      <th>äºˆç´„ã«è¿½åŠ </th>
      <th>æ“ä½œ</th>
    </tr>
  </table>

  <hr class="sep">

  <h3>â‘¡ äºˆç´„å…¥åŠ›ï¼ˆâ€»ä¿å­˜ã—ãªã„ï¼‰</h3>
  <div class="row">
    äºˆç´„ã‚¿ã‚¤ãƒ—
    <select id="rc_resType" onchange="rc_syncResTypeUI()">
      <option value="course">ã‚³ãƒ¼ã‚¹</option>
      <option value="seat">å¸­ã®ã¿</option>
    </select>

    <span id="rc_coursePickWrap">
      ã‚³ãƒ¼ã‚¹
      <select id="rc_resCourse"></select>
    </span>

    äººæ•° <input type="number" id="rc_resPeople" value="2" min="1" style="width:80px;">
    ãƒ¡ãƒ¢ <input id="rc_resMemo" placeholder="ä¾‹ï¼š19:00 / ä¼šç¤¾å®´ä¼š" style="min-width:240px;">

    <button class="add-btn" type="button" onclick="rc_addReservation()">ï¼‹ äºˆç´„è¿½åŠ </button>
    <button class="muted-btn" type="button" onclick="rc_clearAllReservations()">ğŸ—‘ äºˆç´„ä¸€æ‹¬å‰Šé™¤</button>
  </div>

  <table id="rc_resTable">
    <tr>
      <th>#</th>
      <th>ã‚¿ã‚¤ãƒ—</th>
      <th>å†…å®¹</th>
      <th>äººæ•°</th>
      <th>å˜ä¾¡ï¼ˆå††/äººï¼‰</th>
      <th>å°è¨ˆï¼ˆå††ï¼‰</th>
      <th>ãƒ¡ãƒ¢</th>
      <th>å‰Šé™¤</th>
    </tr>
  </table>

  <div class="small">
    â€»äºˆç´„ï¼ˆã“ã®ä¸€è¦§ï¼‰ã¯ä¿å­˜ã—ã¾ã›ã‚“ã€‚æ›´æ–°ãƒ»å†èµ·å‹•ã§æ¶ˆãˆã¾ã™ï¼ˆã‚³ãƒ¼ã‚¹/å¸­ã®ã¿å˜ä¾¡ã¯ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚
  </div>

  <hr class="sep">

  <h3>â‘¢ äºˆç´„é›†è¨ˆ</h3>
  <div class="result" id="rc_totalResult">äºˆç´„è¦‹è¾¼ã¿å£²ä¸Šåˆè¨ˆï¼š0 å††</div>
  <div id="rc_breakdown" class="small"></div>
  <div class="row" style="margin-top:10px;">
    <button class="ok-btn" type="button" onclick="rc_copySummary()">ğŸ“‹ äºˆç´„é›†è¨ˆã‚’ã‚³ãƒ”ãƒ¼</button>
    <span class="small">â€»ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</span>
  </div>
</div>

<!-- ===== å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³ ===== -->
<div class="box">
<h3>â‘  å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³ç™»éŒ²ï¼ˆä¿å­˜ï¼‰</h3>
åå‰ <input id="pName">
é–‹å§‹ <input type="time" id="pStart">
çµ‚äº† <input type="time" id="pEnd">
äººæ•° <input type="number" id="pCount" value="1" style="width:60px">
ãƒã‚¸ã‚·ãƒ§ãƒ³
<select id="pPos">
  <option value="ãƒ›ãƒ¼ãƒ«">ãƒ›ãƒ¼ãƒ«</option>
  <option value="ã‚­ãƒƒãƒãƒ³">ã‚­ãƒƒãƒãƒ³</option>
  <option value="ãã®ä»–">ãã®ä»–</option>
</select>
<button class="add-btn" onclick="addPattern()">è¿½åŠ </button>
<button class="reset-btn" onclick="clearAllPatterns()">ğŸ—‘ ä¸€æ‹¬å‰Šé™¤</button>

<table id="patternTable">
<tr><th>åå‰</th><th>é–‹å§‹</th><th>çµ‚äº†</th><th>äººæ•°</th><th>ãƒã‚¸ã‚·ãƒ§ãƒ³</th><th>æ“ä½œ</th></tr>
</table>
</div>

<!-- ===== ã‚¢ãƒ«ãƒã‚¤ãƒˆå…¥åŠ› ===== -->
<div class="box">
<h3>â‘¡ ã‚¢ãƒ«ãƒã‚¤ãƒˆå‡ºå‹¤å…¥åŠ›</h3>
<table id="timeTable">
<tr>
<th>#</th><th>å‰Šé™¤</th><th>ãƒ‘ã‚¿ãƒ¼ãƒ³</th><th>ãƒã‚¸ã‚·ãƒ§ãƒ³</th>
<th>å‡ºå‹¤</th><th>é€€å‹¤</th>
<th>æ‹˜æŸ</th><th>ä¼‘æ†©(åˆ†)</th><th>å®Ÿåƒ</th><th>äººä»¶è²»</th>
</tr>
</table>
<button class="add-btn" onclick="addRow()">ï¼‹ è¡Œè¿½åŠ </button>
<button class="reset-btn" onclick="clearAllRows()">ğŸ—‘ ä¸€æ‹¬å‰Šé™¤</button>
</div>

<div class="box">
<button class="calc-btn" onclick="calc()">è¨ˆç®—ã™ã‚‹</button>
<p class="result" id="result"></p>
</div>

<script>
/* =========================
   BASE J = BASE I ã‚’æ­£ã¨ã—ã¦
   å¤‰æ›´ç‚¹ï¼šäºˆç´„ï¼ˆâ‘¡äºˆç´„å…¥åŠ›ã®è¡Œãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’ localStorage ä¿å­˜ã—ãªã„
   - å¸­ã®ã¿å˜ä¾¡/ã‚³ãƒ¼ã‚¹/è‡ªå‹•åæ˜ è¨­å®šã¯ä¿å­˜
   - äºˆç´„ä¸€è¦§ã¯ãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ï¼ˆæ›´æ–°ã§æ¶ˆãˆã‚‹ï¼‰
   ========================= */

/* ===== BASEï¼ˆäººä»¶è²»å´ï¼‰ ===== */
let patterns = [];
const $ = (id)=>document.getElementById(id);

const els = {
  sales: $("sales"),
  wage: $("wage"),
  staffHall: $("staffHall"),
  staffKitchen: $("staffKitchen"),
  targetRate: $("targetRate"),
  pName: $("pName"),
  pStart: $("pStart"),
  pEnd: $("pEnd"),
  pCount: $("pCount"),
  pPos: $("pPos"),
  patternTable: $("patternTable"),
  timeTable: $("timeTable"),
  result: $("result"),
};

function adjustSales(delta){
  let v = Number(els.sales.value || 0);
  v += delta;
  if(v < 0) v = 0;
  els.sales.value = v;
}

function savePatterns(){ localStorage.setItem("workPatterns", JSON.stringify(patterns)); }
function loadPatterns(){
  const d = localStorage.getItem("workPatterns");
  if(d){
    patterns = JSON.parse(d);
    renderPatterns();
  }
}
function saveWage(){ localStorage.setItem("baseWage", els.wage.value); }
function loadWage(){
  const w = localStorage.getItem("baseWage");
  if(w) els.wage.value = w;
}
function saveTargetRate(){ localStorage.setItem("targetRate", els.targetRate.value); }
function loadTargetRate(){
  const t = localStorage.getItem("targetRate");
  if(t) els.targetRate.value = t;
}

function clearAllRows(){
  if(!confirm("ã‚¢ãƒ«ãƒã‚¤ãƒˆå…¥åŠ›ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const table = els.timeTable;
  while(table.rows.length > 1){
    table.deleteRow(1);
  }
}

function clearAllPatterns(){
  if(!confirm("å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;
  patterns = [];
  savePatterns();
  renderPatterns();
}

function adjustRest(btn, delta){
  const row = btn.closest("tr");
  const input = row.querySelector(".rest");
  let v = Number(input.value || 0) + delta;
  if(v < 0) v = 0;
  input.value = v;
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç† */
function addPattern(){
  const name = els.pName.value;
  const start = els.pStart.value;
  const end = els.pEnd.value;
  const count = Number(els.pCount.value);

  if(!name || !start || !end || count <= 0){
    alert("å…¨éƒ¨å…¥åŠ›ã—ã¦"); return;
  }

  patterns.push({
    name: name,
    start: start,
    end: end,
    count: count,
    pos: els.pPos.value
  });

  savePatterns();
  renderPatterns();

  els.pName.value = "";
  els.pStart.value = "";
  els.pEnd.value = "";
  els.pCount.value = 1;
}

function deletePattern(i){
  if(!confirm("ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  patterns.splice(i,1);
  savePatterns();
  renderPatterns();
}

function renderPatterns(){
  const header = "<tr><th>åå‰</th><th>é–‹å§‹</th><th>çµ‚äº†</th><th>äººæ•°</th><th>ãƒã‚¸ã‚·ãƒ§ãƒ³</th><th>æ“ä½œ</th></tr>";
  let html = header;

  for(let i=0;i<patterns.length;i++){
    const p = patterns[i];
    html += `
    <tr>
      <td>${p.name}</td>
      <td>${p.start}</td>
      <td>${p.end}</td>
      <td>${p.count}</td>
      <td>${p.pos}</td>
      <td>
        <button class="pattern-btn" onclick="addByPattern(${i})">äººå“¡è¿½åŠ </button>
        <button class="delete-btn" onclick="deletePattern(${i})">å‰Šé™¤</button>
      </td>
    </tr>`;
  }

  els.patternTable.innerHTML = html;

  const selects = document.querySelectorAll(".patternSelect");
  for(let i=0;i<selects.length;i++){
    fillSelect(selects[i]);
  }
}

function fillSelect(sel){
  let html = `<option value="">--é¸æŠ--</option>`;
  for(let i=0;i<patterns.length;i++){
    html += `<option value="${i}">${patterns[i].name}</option>`;
  }
  sel.innerHTML = html;
}

/* ã‚¢ãƒ«ãƒã‚¤ãƒˆè¡Œ */
function addRow(start="", end="", idx="", pos="ãƒ›ãƒ¼ãƒ«"){
  const table = els.timeTable;
  const r = table.insertRow();
  const n = table.rows.length - 1;

  r.innerHTML = `
  <td>${n}</td>
  <td><button class="row-delete" onclick="deleteRow(this)">å‰Šé™¤</button></td>
  <td><select class="patternSelect" onchange="applyPattern(this)"></select></td>
  <td>
    <select class="pos">
      <option value="ãƒ›ãƒ¼ãƒ«">ãƒ›ãƒ¼ãƒ«</option>
      <option value="ã‚­ãƒƒãƒãƒ³">ã‚­ãƒƒãƒãƒ³</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
  </td>
  <td><input type="time" class="start" value="${start}"></td>
  <td><input type="time" class="end" value="${end}"></td>
  <td class="raw">0</td>
  <td>
    <span class="restWrap">
      <input type="number" class="rest restInput" value="0">
      <span class="restBtnCol">
        <button type="button" class="restBtn" onclick="adjustRest(this, 15)">â–²</button>
        <button type="button" class="restBtn" onclick="adjustRest(this, -15)">â–¼</button>
      </span>
    </span>
  </td>
  <td class="work">0</td>
  <td class="cost">0</td>`;

  const sel = r.querySelector(".patternSelect");
  fillSelect(sel);

  if(idx !== ""){
    sel.value = idx;
    r.querySelector(".pos").value = pos;
  }
}

function deleteRow(btn){
  if(!confirm("ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  btn.closest("tr").remove();
  renumberRows();
}

function renumberRows(){
  const rows = els.timeTable.rows;
  for(let i=1;i<rows.length;i++){
    rows[i].cells[0].innerText = i;
  }
}

function addByPattern(i){
  const p = patterns[i];
  for(let c=0;c<p.count;c++){
    addRow(p.start, p.end, i, p.pos);
  }
}

function applyPattern(sel){
  const i = sel.value;
  if(i === "") return;

  const row = sel.closest("tr");
  const p = patterns[i];

  row.querySelector(".start").value = p.start;
  row.querySelector(".end").value = p.end;
  row.querySelector(".pos").value = p.pos;
}

/* è¨ˆç®— */
function toMin(t){
  const a = t.charCodeAt(0)*10 + t.charCodeAt(1) - 528;
  const b = t.charCodeAt(3)*10 + t.charCodeAt(4) - 528;
  return a*60 + b;
}
function autoRestMinutes(rawMin){
  const h = rawMin / 60;
  if(h >= 8) return 60;
  if(h >= 7) return 45;
  if(h >= 6) return 30;
  return 0;
}
function overlapMinutes(aStart, aEnd, bStart, bEnd){
  const s = aStart > bStart ? aStart : bStart;
  const e = aEnd < bEnd ? aEnd : bEnd;
  return e > s ? (e - s) : 0;
}
function calcCostFast(st, en, rest, wagePerHour){
  const raw = en - st;
  if(rest < 0) rest = 0;
  if(rest > raw) rest = raw;

  const paidStart = st + rest;
  const paidEnd = en;

  const paidMinutes = paidEnd - paidStart;
  if(paidMinutes <= 0) return { cost: 0, paidMinutes: 0 };

  const overtimeStart = paidStart + 480;
  const overtimeMinutes = (paidEnd > overtimeStart) ? (paidEnd - overtimeStart) : 0;

  let nightMinutes = 0;
  const dayStart = Math.floor(paidStart / 1440);
  const dayEnd = Math.floor((paidEnd - 1) / 1440);

  for(let d = dayStart; d <= dayEnd; d++){
    const nS = d*1440 + 1320;
    const nE = d*1440 + 1440;
    nightMinutes += overlapMinutes(paidStart, paidEnd, nS, nE);
  }

  let nightOverMinutes = 0;
  if(overtimeMinutes > 0){
    const oS = overtimeStart;
    const oE = paidEnd;

    const odStart = Math.floor(oS / 1440);
    const odEnd = Math.floor((oE - 1) / 1440);
    for(let d = odStart; d <= odEnd; d++){
      const nS = d*1440 + 1320;
      const nE = d*1440 + 1440;
      nightOverMinutes += overlapMinutes(oS, oE, nS, nE);
    }
  }

  const nightOnlyMinutes = nightMinutes - nightOverMinutes;
  const overOnlyMinutes = overtimeMinutes - nightOverMinutes;
  const regularMinutes = paidMinutes - nightOnlyMinutes - overOnlyMinutes - nightOverMinutes;

  const wagePerMin = wagePerHour / 60;

  const cost =
    (regularMinutes * wagePerMin * 1.0) +
    ((nightOnlyMinutes + overOnlyMinutes) * wagePerMin * 1.25) +
    (nightOverMinutes * wagePerMin * 1.5);

  return { cost: cost, paidMinutes: paidMinutes };
}
function fmtYen(n){ return Math.round(Number(n || 0)).toLocaleString(); }
function yenPerHour(sales, hours){ if(!(hours > 0)) return 0; return sales / hours; }

function calc(){
  let totalWork = 0;
  let totalCost = 0;
  const w = Number(els.wage.value);

  let hallCost = 0, kitchenCost = 0, hallH = 0, kitchenH = 0;

  const rows = els.timeTable.rows;
  for(let i=1;i<rows.length;i++){
    const row = rows[i];

    const s = row.querySelector(".start").value;
    const e = row.querySelector(".end").value;
    if(!s || !e) continue;

    let st = toMin(s);
    let en = toMin(e);
    if(en < st) en += 1440;

    const raw = en - st;

    const restInput = row.querySelector(".rest");
    const restVal = restInput.value;
    if(restVal === "" || Number(restVal) === 0){
      restInput.value = autoRestMinutes(raw);
    }

    const rest = Number(restInput.value);
    const work = raw - rest;

    row.querySelector(".raw").innerText = (raw/60).toFixed(2);
    row.querySelector(".work").innerText = (work/60).toFixed(2);

    const cost = calcCostFast(st, en, rest, w).cost;

    row.querySelector(".cost").innerText = fmtYen(cost);
    totalWork += work/60;
    totalCost += cost;

    const pos = row.querySelector(".pos").value;
    if(pos === "ãƒ›ãƒ¼ãƒ«"){ hallCost += cost; hallH += work/60; }
    if(pos === "ã‚­ãƒƒãƒãƒ³"){ kitchenCost += cost; kitchenH += work/60; }
  }

  const staffHallN = Number(els.staffHall.value);
  const staffKitchenN = Number(els.staffKitchen.value);

  const staffHallCost = staffHallN * 16500;
  const staffKitchenCost = staffKitchenN * 16500;

  hallCost += staffHallCost;
  kitchenCost += staffKitchenCost;

  const total = totalCost + staffHallCost + staffKitchenCost;

  const sales = Number(els.sales.value);
  const rate = sales > 0 ? (total / sales * 100) : 0;

  const target = Number(els.targetRate.value);
  const diff = rate - target;

  let judge = "";
  if(diff <= 0){
    judge = `<span class="good">âœ… ç›®æ¨™å†…ï¼ˆ${diff.toFixed(2)}%ï¼‰</span>`;
  }else{
    const overMoney = sales * (diff/100);
    const needHour = overMoney / w;
    judge = `<span class="bad">âš  è¶…é +${diff.toFixed(2)}%</span><br>
    å‰Šæ¸›ç›®å®‰ï¼š${fmtYen(overMoney)} å†† ï¼ ç´„ ${needHour.toFixed(2)} æ™‚é–“`;
  }

  const hallHoursInclStaff = hallH + staffHallN * 10;
  const kitchenHoursInclStaff = kitchenH + staffKitchenN * 10;
  const totalHoursInclStaff = totalWork + (staffHallN + staffKitchenN) * 10;

  const hallSalesPerHour = yenPerHour(sales, hallHoursInclStaff);
  const kitchenSalesPerHour = yenPerHour(sales, kitchenHoursInclStaff);
  const totalSalesPerHour = yenPerHour(sales, totalHoursInclStaff);

  els.result.innerHTML = `
  äººä»¶è²»ç‡ï¼š${rate.toFixed(2)} %ï¼ˆç›®æ¨™ ${target}%ï¼‰<br>
  ${judge}<br><br>

  äººä»¶è²»åˆè¨ˆï¼š${fmtYen(total)} å††<br><br>

  ğŸ§ ãƒ›ãƒ¼ãƒ«ï¼š${hallH.toFixed(2)} h / ${fmtYen(hallCost)} å††<br>
  ğŸ³ ã‚­ãƒƒãƒãƒ³ï¼š${kitchenH.toFixed(2)} h / ${fmtYen(kitchenCost)} å††<br><br>

  ğŸ“Œ äººæ™‚å£²ä¸Šé«˜ï¼ˆè¦‹è¾¼ã¿å£²ä¸Š Ã· å®ŸåŠ´åƒæ™‚é–“ï¼‰<br>
  ãƒ»ãƒ›ãƒ¼ãƒ«ï¼š${fmtYen(hallSalesPerHour)} å†† / hï¼ˆå®ŸåŠ´åƒ ${hallHoursInclStaff.toFixed(2)} h â€»ç¤¾å“¡${staffHallN}äººÃ—10hå«ã‚€ï¼‰<br>
  ãƒ»ã‚­ãƒƒãƒãƒ³ï¼š${fmtYen(kitchenSalesPerHour)} å†† / hï¼ˆå®ŸåŠ´åƒ ${kitchenHoursInclStaff.toFixed(2)} h â€»ç¤¾å“¡${staffKitchenN}äººÃ—10hå«ã‚€ï¼‰<br>
  ãƒ»åˆç®—ï¼š${fmtYen(totalSalesPerHour)} å†† / hï¼ˆå®ŸåŠ´åƒ ${totalHoursInclStaff.toFixed(2)} h â€»ç¤¾å“¡åˆè¨ˆÃ—10hå«ã‚€ï¼‰
  `;
}

/* =========================
   äºˆç´„ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå¤‰æ›´ç‚¹ï¼šäºˆç´„ã¯ä¿å­˜ã—ãªã„ï¼‰
   ========================= */
const RC_LS = {
  seatUnit: "rc_seatUnit",
  courses: "rc_courses",
  lastQuickPeople: "rc_lastQuickPeople",
  autoApply: "rc_autoApply"
};

let rc_courses = [];       // ä¿å­˜ã‚ã‚Š
let rc_reservations = [];  // â˜…ä¿å­˜ãªã—ï¼ˆãƒ¡ãƒ¢ãƒªã®ã¿ï¼‰

const rc = {
  seatUnit: $("rc_seatUnit"),
  courseName: $("rc_courseName"),
  coursePrice: $("rc_coursePrice"),
  courseTable: $("rc_courseTable"),

  resType: $("rc_resType"),
  coursePickWrap: $("rc_coursePickWrap"),
  resCourse: $("rc_resCourse"),
  resPeople: $("rc_resPeople"),
  resMemo: $("rc_resMemo"),
  resTable: $("rc_resTable"),

  totalResult: $("rc_totalResult"),
  breakdown: $("rc_breakdown"),
  autoApply: $("rc_autoApply"),
};

function rc_uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function rc_fmtYen(n){ return Math.round(Number(n || 0)).toLocaleString(); }
function rc_clampInt(v, min, max){
  v = Math.floor(Number(v || 0));
  if(v < min) v = min;
  if(v > max) v = max;
  return v;
}
function rc_escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ä¿å­˜/èª­è¾¼ï¼ˆäºˆç´„ã¯å¯¾è±¡å¤–ï¼‰ */
function rc_saveSeatUnit(){
  const v = Number(rc.seatUnit.value || 0);
  localStorage.setItem(RC_LS.seatUnit, String(v));
  rc_recalc();
}
function rc_loadSeatUnit(){
  const v = localStorage.getItem(RC_LS.seatUnit);
  if(v !== null) rc.seatUnit.value = v;
}
function rc_saveCourses(){ localStorage.setItem(RC_LS.courses, JSON.stringify(rc_courses)); }
function rc_loadCourses(){
  const raw = localStorage.getItem(RC_LS.courses);
  if(!raw) return;
  try{
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) rc_courses = arr;
  }catch(e){}
}

/* è‡ªå‹•åæ˜ è¨­å®šï¼ˆä¿å­˜ã‚ã‚Šï¼‰ */
function rc_onToggleAutoApply(){
  localStorage.setItem(RC_LS.autoApply, rc.autoApply.checked ? "1" : "0");
  if(rc.autoApply.checked){
    rc_applyTotalToSales(false);
  }
}
function rc_loadAutoApply(){
  const v = localStorage.getItem(RC_LS.autoApply);
  rc.autoApply.checked = (v === "1");
}

/* ã‚³ãƒ¼ã‚¹ */
function rc_addCourse(){
  const name = (rc.courseName.value || "").trim();
  const price = Number(rc.coursePrice.value || 0);

  if(!name || !(price > 0)){
    alert("ã‚³ãƒ¼ã‚¹åã¨é‡‘é¡ï¼ˆ0ã‚ˆã‚Šå¤§ãã„ï¼‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
    return;
  }

  rc_courses.push({ id: rc_uid(), name, price });
  rc_saveCourses();

  rc.courseName.value = "";
  rc.coursePrice.value = "";

  rc_renderCourses();
  rc_renderCourseSelect();
  rc_recalc();
}

function rc_deleteCourse(courseId){
  if(!confirm("ã“ã®ã‚³ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  rc_courses = rc_courses.filter(c => c.id !== courseId);
  rc_saveCourses();
  rc_renderCourses();
  rc_renderCourseSelect();
  rc_recalc();
}

function rc_clearAllCourses(){
  if(!confirm("ã‚³ãƒ¼ã‚¹ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã¾ã™ï¼‰")) return;
  rc_courses = [];
  rc_saveCourses();
  rc_renderCourses();
  rc_renderCourseSelect();
  rc_recalc();
}

function rc_renderCourses(){
  rc.courseTable.innerHTML = `
    <tr>
      <th>ã‚³ãƒ¼ã‚¹å</th>
      <th>é‡‘é¡ï¼ˆå††/äººï¼‰</th>
      <th>äºˆç´„ã«è¿½åŠ </th>
      <th>æ“ä½œ</th>
    </tr>
  `;

  for(const c of rc_courses){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="left">${rc_escapeHtml(c.name)}</td>
      <td class="right nowrap">${rc_fmtYen(c.price)}</td>
      <td>
        <button class="add-btn" type="button" onclick="rc_quickAddCourse('${c.id}')">ï¼‹è¿½åŠ </button>
      </td>
      <td>
        <button class="delete-btn" type="button" onclick="rc_deleteCourse('${c.id}')">å‰Šé™¤</button>
      </td>
    `;
    rc.courseTable.appendChild(tr);
  }
}

function rc_renderCourseSelect(){
  rc.resCourse.innerHTML = "";
  if(rc_courses.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "ï¼ˆã‚³ãƒ¼ã‚¹æœªç™»éŒ²ï¼‰";
    rc.resCourse.appendChild(opt);
    return;
  }
  for(const c of rc_courses){
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.name}ï¼ˆ${rc_fmtYen(c.price)}å††/äººï¼‰`;
    rc.resCourse.appendChild(opt);
  }
}

/* ã‚³ãƒ¼ã‚¹è¡¨ã®ï¼‹è¿½åŠ ï¼šäººæ•°prompt */
function rc_quickAddCourse(courseId){
  const course = rc_courses.find(c => c.id === courseId);
  if(!course){
    alert("ã‚³ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ï¼‰");
    return;
  }

  const last = localStorage.getItem(RC_LS.lastQuickPeople);
  const defPeople = (last !== null && Number(last) > 0) ? String(Math.floor(Number(last))) : "2";

  const input = prompt(`äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ${course.name}ï¼‰`, defPeople);
  if(input === null) return;

  const people = rc_clampInt(Number(input), 1, 999);
  if(!(people > 0)){
    alert("äººæ•°ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  localStorage.setItem(RC_LS.lastQuickPeople, String(people));

  rc_reservations.push({
    id: rc_uid(),
    type: "course",
    courseId: course.id,
    people,
    unit: course.price,
    memo: (rc.resMemo.value || "").trim()
  });

  rc_renderReservations();
  rc_recalc();
}

/* äºˆç´„å…¥åŠ› */
function rc_syncResTypeUI(){
  const t = rc.resType.value;
  rc.coursePickWrap.style.display = (t === "course") ? "inline-flex" : "none";
}

function rc_addReservation(){
  const type = rc.resType.value;
  const people = rc_clampInt(Number(rc.resPeople.value || 1), 1, 999);
  const memo = (rc.resMemo.value || "").trim();

  if(type === "course"){
    const courseId = rc.resCourse.value;
    const course = rc_courses.find(c => c.id === courseId);
    if(!course){
      alert("ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆæœªç™»éŒ²ã®å ´åˆã¯å…ˆã«ç™»éŒ²ï¼‰");
      return;
    }
    rc_reservations.push({
      id: rc_uid(),
      type: "course",
      courseId: course.id,
      people,
      unit: course.price,
      memo
    });
  }else{
    const unit = Number(rc.seatUnit.value || 0);
    if(!(unit > 0)){
      alert("å¸­ã®ã¿å®¢å˜ä¾¡ãŒ0ã§ã™ã€‚è¨­å®šã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    rc_reservations.push({
      id: rc_uid(),
      type: "seat",
      courseId: "",
      people,
      unit,
      memo
    });
  }

  rc_renderReservations();
  rc_recalc();
}

function rc_deleteReservation(resId){
  if(!confirm("ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  rc_reservations = rc_reservations.filter(r => r.id !== resId);
  rc_renderReservations();
  rc_recalc();
}

function rc_clearAllReservations(){
  if(!confirm("äºˆç´„ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ç”»é¢ã®å…¥åŠ›ã ã‘æ¶ˆãˆã¾ã™ï¼‰")) return;
  rc_reservations = [];
  rc_renderReservations();
  rc_recalc();
}

function rc_renderReservations(){
  rc.resTable.innerHTML = `
    <tr>
      <th>#</th>
      <th>ã‚¿ã‚¤ãƒ—</th>
      <th>å†…å®¹</th>
      <th>äººæ•°</th>
      <th>å˜ä¾¡ï¼ˆå††/äººï¼‰</th>
      <th>å°è¨ˆï¼ˆå††ï¼‰</th>
      <th>ãƒ¡ãƒ¢</th>
      <th>å‰Šé™¤</th>
    </tr>
  `;

  rc_reservations.forEach((r, idx) => {
    const tr = document.createElement("tr");

    let typeLabel = (r.type === "course") ? "ã‚³ãƒ¼ã‚¹" : "å¸­ã®ã¿";
    let detail = "";
    if(r.type === "course"){
      const c = rc_courses.find(x => x.id === r.courseId);
      detail = c ? c.name : "ï¼ˆå‰Šé™¤æ¸ˆã‚³ãƒ¼ã‚¹ï¼‰";
    }else{
      detail = "å¸­ã®ã¿";
    }

    const people = rc_clampInt(Number(r.people || 0), 0, 9999);
    const unit = Number(r.unit || 0);
    const subtotal = people * unit;

    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td class="nowrap">${typeLabel}</td>
      <td class="left">${rc_escapeHtml(detail)}</td>
      <td class="right">${people}</td>
      <td class="right nowrap">${rc_fmtYen(unit)}</td>
      <td class="right nowrap">${rc_fmtYen(subtotal)}</td>
      <td class="left">${rc_escapeHtml(r.memo || "")}</td>
      <td><button class="delete-btn" type="button" onclick="rc_deleteReservation('${r.id}')">å‰Šé™¤</button></td>
    `;
    rc.resTable.appendChild(tr);
  });
}

/* é›†è¨ˆ */
function rc_getTotal(){
  let total = 0;
  for(const r of rc_reservations){
    const people = rc_clampInt(Number(r.people || 0), 0, 999999);
    const unit = Number(r.unit || 0);
    total += people * unit;
  }
  return total;
}

function rc_recalc(){
  let total = 0;

  const byCourse = new Map();
  let seatSubtotal = 0;
  let seatPeople = 0;

  for(const r of rc_reservations){
    const people = rc_clampInt(Number(r.people || 0), 0, 999999);
    const unit = Number(r.unit || 0);
    const subtotal = people * unit;
    total += subtotal;

    if(r.type === "seat"){
      seatSubtotal += subtotal;
      seatPeople += people;
    }else{
      const c = rc_courses.find(x => x.id === r.courseId);
      const name = c ? c.name : "ï¼ˆå‰Šé™¤æ¸ˆã‚³ãƒ¼ã‚¹ï¼‰";
      const key = r.courseId || "deleted_course";
      const cur = byCourse.get(key) || { name, subtotal: 0, people: 0 };
      cur.subtotal += subtotal;
      cur.people += people;
      cur.name = name;
      byCourse.set(key, cur);
    }
  }

  rc.totalResult.textContent = `äºˆç´„è¦‹è¾¼ã¿å£²ä¸Šåˆè¨ˆï¼š${rc_fmtYen(total)} å††`;

  let html = "";
  if(rc_reservations.length === 0){
    html = `<div class="warn">â€»äºˆç´„ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
  }else{
    html += `<div>å†…è¨³ï¼š</div><ul style="margin:6px 0 0 18px;">`;

    const courseItems = Array.from(byCourse.values()).sort((a,b)=> b.subtotal - a.subtotal);
    for(const item of courseItems){
      html += `<li>ã‚³ãƒ¼ã‚¹ï¼š${rc_escapeHtml(item.name)} â€¦ ${item.people}å / ${rc_fmtYen(item.subtotal)}å††</li>`;
    }

    html += `<li>å¸­ã®ã¿ â€¦ ${seatPeople}å / ${rc_fmtYen(seatSubtotal)}å††ï¼ˆå˜ä¾¡ ${rc_fmtYen(Number(rc.seatUnit.value||0))}å††/äººï¼‰</li>`;
    html += `</ul>`;
  }
  rc.breakdown.innerHTML = html;

  if(rc.autoApply.checked){
    rc_applyTotalToSales(false);
  }
}

function rc_applyTotalToSales(showAlert=true){
  const total = rc_getTotal();
  els.sales.value = total;
  if(showAlert) alert("äºˆç´„åˆè¨ˆã‚’è¦‹è¾¼ã¿å£²ä¸Šã«åæ˜ ã—ã¾ã—ãŸ");
}

function rc_copySummary(){
  const seatUnit = Number(rc.seatUnit.value || 0);
  let total = 0;

  const byCourse = new Map();
  let seatSubtotal = 0;
  let seatPeople = 0;

  for(const r of rc_reservations){
    const people = rc_clampInt(Number(r.people || 0), 0, 999999);
    const unit = Number(r.unit || 0);
    const subtotal = people * unit;
    total += subtotal;

    if(r.type === "seat"){
      seatSubtotal += subtotal;
      seatPeople += people;
    }else{
      const c = rc_courses.find(x => x.id === r.courseId);
      const name = c ? c.name : "ï¼ˆå‰Šé™¤æ¸ˆã‚³ãƒ¼ã‚¹ï¼‰";
      const key = r.courseId || "deleted_course";
      const cur = byCourse.get(key) || { name, subtotal: 0, people: 0 };
      cur.subtotal += subtotal;
      cur.people += people;
      cur.name = name;
      byCourse.set(key, cur);
    }
  }

  let lines = [];
  lines.push(`ã€äºˆç´„ã‚«ã‚¦ãƒ³ãƒˆã€‘`);
  lines.push(`è¦‹è¾¼ã¿å£²ä¸Šåˆè¨ˆï¼š${rc_fmtYen(total)}å††`);
  lines.push(`--- å†…è¨³ ---`);

  const courseItems = Array.from(byCourse.values()).sort((a,b)=> b.subtotal - a.subtotal);
  for(const item of courseItems){
    lines.push(`ã‚³ãƒ¼ã‚¹ï¼š${item.name} â€¦ ${item.people}å / ${rc_fmtYen(item.subtotal)}å††`);
  }
  lines.push(`å¸­ã®ã¿ â€¦ ${seatPeople}å / ${rc_fmtYen(seatSubtotal)}å††ï¼ˆå˜ä¾¡ ${rc_fmtYen(seatUnit)}å††/äººï¼‰`);

  const text = lines.join("\n");

  navigator.clipboard.writeText(text)
    .then(()=> alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"))
    .catch(()=> alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™è¨­å®šã‚’ç¢ºèªï¼‰"));
}

/* ===== init ===== */
window.onload = function(){
  // äººä»¶è²»å´
  loadPatterns();
  loadWage();
  loadTargetRate();

  // äºˆç´„å´ï¼ˆäºˆç´„ã¯ä¿å­˜ã—ãªã„ã®ã§ loadãªã—ï¼‰
  rc_loadAutoApply();
  rc_loadSeatUnit();
  rc_loadCourses();

  rc_renderCourses();
  rc_renderCourseSelect();
  rc_renderReservations(); // åˆæœŸã¯ç©º
  rc_syncResTypeUI();
  rc_recalc();
};
</script>

</body>
</html>
