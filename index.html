<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>å®´ä¼š è¦‹è¾¼ã¿åŸä¾¡ï¼ˆé–‹å§‹/çµ‚äº†åœ¨åº«ï¼‰ Sample U</title>

  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --danger:#dc2626; --warn:#d97706; --ok:#16a34a;
      --shadow: 0 10px 28px rgba(0,0,0,.08); --radius:16px;
      --input-bg:#ffffff; --input-text:#111827; --input-border:#d1d5db;
    }
    :root[data-theme="dark"]{
      --bg:#0b0b0c; --card:#141416; --text:#f3f4f6; --muted:#a1a1aa; --line:#26282c;
      --accent:#66e3ff; --danger:#ff6b6b; --warn:#ffb020; --ok:#34d399;
      --shadow: 0 12px 34px rgba(0,0,0,.28);
      --input-bg:#0f1012; --input-text:#f3f4f6; --input-border:#2b2f36;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; z-index:10; background: color-mix(in oklab, var(--bg) 92%, transparent); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); padding:14px; }
    .top{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:16px; letter-spacing:.02em; }
    .pill{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted);
      background: color-mix(in oklab, var(--card) 86%, transparent); display:inline-flex; gap:8px; align-items:center; white-space:nowrap; }
    .themeBtn{ padding:8px 10px; border-radius:999px; font-size:13px; border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 88%, var(--bg)); color:var(--text); cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    nav{ display:flex; gap:8px; margin-top:10px; }
    .tab{ flex:1; border:1px solid var(--line); background:transparent; border-radius:999px; padding:10px 8px; font-size:13px; color:var(--muted); cursor:pointer; }
    .tab.active{ color:var(--text); border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      background: color-mix(in oklab, var(--accent) 6%, transparent); box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent) 18%, transparent) inset; }
    .tab.disabled{ opacity:.5; cursor:not-allowed; }

    main{ padding:14px; max-width:1150px; margin:0 auto; }
    .grid{ display:grid; gap:12px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, textarea{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--input-text); font-size:14px; outline:none; }
    button{ border:1px solid var(--line); background: color-mix(in oklab, var(--card) 88%, var(--bg)); color:var(--text); padding:10px 12px; border-radius:12px; font-size:14px; cursor:pointer; }
    button.primary{ border-color: color-mix(in oklab, var(--accent) 60%, var(--line)); background: color-mix(in oklab, var(--accent) 10%, var(--card)); }
    button.danger{ border-color: color-mix(in oklab, var(--danger) 65%, var(--line)); background: color-mix(in oklab, var(--danger) 10%, var(--card)); }
    button.warn{ border-color: color-mix(in oklab, var(--warn) 65%, var(--line)); background: color-mix(in oklab, var(--warn) 10%, var(--card)); }
    button.ghost{ background:transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:160px; }
    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; align-items:center; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); line-height:1.5; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    .stepNo{ display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; border-radius:999px; border:2.5px solid var(--danger);
      color:var(--danger); font-weight:900; font-size:18px; line-height:1; flex:0 0 auto; transform: translateY(2px); }
    .manualBar{ margin-top:10px; border:1px solid var(--line); border-radius:14px; padding:10px 12px;
      background: color-mix(in oklab, var(--card) 88%, var(--bg)); display:grid; gap:6px; }
    .manualLine{ font-size:12px; color:var(--muted); line-height:1.5; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .manualChip{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text); display:inline-flex; gap:8px; align-items:center; white-space:nowrap; font-size:12px; }

    .kpiGrid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; }
    .kpi{ border:1px solid var(--line); border-radius:14px; padding:10px 12px; background: color-mix(in oklab, var(--card) 92%, var(--bg)); }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:18px; margin-top:4px; }

    .locked{ opacity:.55; filter:saturate(.85); pointer-events:none; }
    .lockNote{ border:1px solid color-mix(in oklab, var(--warn) 40%, var(--line)); background: color-mix(in oklab, var(--warn) 8%, var(--card));
      border-radius:14px; padding:10px 12px; display:flex; gap:10px; align-items:flex-start; }

    .stageWrap{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .seg{ display:inline-flex; border:1px solid var(--line); border-radius:999px; overflow:hidden; background: color-mix(in oklab, var(--card) 90%, var(--bg)); }
    .seg button{ border:none; border-right:1px solid var(--line); border-radius:0; padding:10px 14px; font-size:13px; background:transparent; color:var(--muted); cursor:pointer; }
    .seg button:last-child{ border-right:none; }
    .seg button.active{ color:var(--text); background: color-mix(in oklab, var(--accent) 10%, var(--card)); }
    .dot{ width:10px; height:10px; border-radius:50%; background: color-mix(in oklab, var(--warn) 70%, transparent); display:inline-block; }
    .dot.ok{ background: color-mix(in oklab, var(--ok) 70%, transparent); }
    .dot.run{ background: color-mix(in oklab, var(--accent) 70%, transparent); }
    .dot.bad{ background: color-mix(in oklab, var(--danger) 70%, transparent); }

    .list{ display:grid; gap:10px; }
    .item{ border:1px solid var(--line); background: color-mix(in oklab, var(--card) 92%, var(--bg)); border-radius:14px; padding:12px; }
    .itemHeader{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .itemHeader h3{ margin:0; font-size:14px; }
    .badge{ font-size:11px; color:var(--muted); padding:4px 8px; border:1px solid var(--line); border-radius:999px; white-space:nowrap;
      background: color-mix(in oklab, var(--card) 80%, transparent); display:inline-flex; gap:6px; align-items:center; }
    .badge.warn{ color: color-mix(in oklab, var(--warn) 80%, var(--text)); border-color: color-mix(in oklab, var(--warn) 45%, var(--line));
      background: color-mix(in oklab, var(--warn) 8%, var(--card)); }

    .prodRow{ display:grid; grid-template-columns: 1fr 560px; gap:10px; align-items:center; padding:12px 0;
      border-top:1px dashed color-mix(in oklab, var(--text) 12%, transparent); }
    .prodRow:first-child{ border-top:none; padding-top:0; }
    .prodName{ font-size:16px; font-weight:800; text-align:center; letter-spacing:.02em; }
    .prodMeta{ font-size:12px; color:var(--muted); margin-top:6px; text-align:center; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; }

    .controls{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; align-items:stretch; }
    .ctrlBox{ border:1px solid var(--line); border-radius:14px; padding:10px; background: color-mix(in oklab, var(--card) 92%, var(--bg)); }
    .ctrlBox.startBox{ background: color-mix(in oklab, #ef4444 7%, var(--card)); border-color: color-mix(in oklab, #ef4444 22%, var(--line)); }
    .ctrlBox.endBox{ background: color-mix(in oklab, #3b82f6 7%, var(--card)); border-color: color-mix(in oklab, #3b82f6 22%, var(--line)); }
    .ctrlBox.readonly{ opacity:.92; filter:saturate(.9); }
    .ctrlTitle{ display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted); margin-bottom:10px; }
    .ctrlGrid{ display:grid; grid-template-columns: 48px 62px 1fr 62px 48px; gap:8px; align-items:center; }
    .stepBtn{ height:50px; display:flex; align-items:center; justify-content:center; border-radius:12px; border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 85%, var(--bg)); user-select:none; cursor:pointer; font-size:14px; font-weight:700; }
    .startBox .stepBtn.primary{ border-color: color-mix(in oklab, #ef4444 45%, var(--line)); background: color-mix(in oklab, #ef4444 10%, var(--card)); }
    .endBox .stepBtn.primary{ border-color: color-mix(in oklab, #3b82f6 45%, var(--line)); background: color-mix(in oklab, #3b82f6 10%, var(--card)); }
    .qtyInput{ height:50px; text-align:center; font-size:18px; padding:12px 10px; border-radius:12px; border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 78%, var(--bg)); }
    .roQty{ height:50px; border-radius:12px; border:1px solid var(--line); background: color-mix(in oklab, var(--card) 78%, var(--bg));
      display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; }
    .usedBox{ border:1px solid var(--line); border-radius:14px; padding:12px; background: color-mix(in oklab, var(--card) 92%, var(--bg));
      display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:flex-end; min-height:100%; }
    .usedLine{ font-size:12px; color:var(--muted); }
    .usedVal{ font-size:18px; font-weight:900; }
    .usedVal.negative{ color:var(--danger); }
    .usedVal.missing{ color:var(--warn); }

    .editBox{ border:1px dashed color-mix(in oklab, var(--text) 18%, transparent); border-radius:14px; padding:12px; margin-top:10px;
      background: color-mix(in oklab, var(--card) 90%, var(--bg)); }
    .editTitle{ font-weight:900; font-size:13px; margin:0 0 8px; }

    .alert{
      border:1px solid color-mix(in oklab, var(--danger) 40%, var(--line));
      background: color-mix(in oklab, var(--danger) 7%, var(--card));
      border-radius:14px;
      padding:10px 12px;
      display:none;
      gap:10px;
      align-items:flex-start;
    }
    .alert.show{ display:flex; }
    .alert b{ color:var(--danger); }
    .dangermsg{ color:var(--danger); }

    .draftRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .draftList{ display:grid; gap:8px; margin-top:10px; }
    .draftItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background: color-mix(in oklab, var(--card) 92%, var(--bg));
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .draftItem.active{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      box-shadow: 0 0 0 1px color-mix(in oklab, var(--accent) 18%, transparent) inset;
      background: color-mix(in oklab, var(--accent) 5%, var(--card));
    }

    @media (max-width: 980px){
      .prodRow{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr; }
      .usedBox{ align-items:flex-start; }
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <h1>å®´ä¼š è¦‹è¾¼ã¿åŸä¾¡ï¼ˆé–‹å§‹/çµ‚äº†åœ¨åº«ï¼‰ - Sample Uï¼ˆä¸‹æ›¸ããƒœã‚¿ãƒ³ä¿®æ­£ç‰ˆ / å£²ä¸Šã¯ç¨æŠœè¨ˆç®—ï¼‰</h1>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <button id="btnTheme" class="themeBtn" type="button">â˜€ï¸ <span class="mono" style="font-size:12px;">LIGHT</span></button>
      <button id="btnReloadNow" class="themeBtn" type="button">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
      <div class="pill"><span id="appState">app: bootingâ€¦</span></div>
      <div class="pill"><span id="netState">ğŸŸ¢ online</span></div>
      <div class="pill"><span id="syncDot" class="dot"></span> <span id="syncState">ä¸‹æ›¸ãåŒæœŸï¼šâ€”</span></div>
      <div class="pill"><span id="authState">æœªãƒ­ã‚°ã‚¤ãƒ³</span> <span class="mono" id="deviceId">â€”</span></div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="banquet" id="tabBtnBanquet">å®´ä¼š</button>
    <button class="tab" data-tab="master" id="tabBtnMaster">å•†å“ãƒã‚¹ã‚¿</button>
    <button class="tab" data-tab="sync" id="tabBtnSync">åŒæœŸ/ãƒ­ã‚°</button>
  </nav>

  <div class="manualBar">
    <div class="manualLine">
      <span class="manualChip"><span class="stepNo">1</span>ãƒ­ã‚°ã‚¤ãƒ³</span>
      <span class="manualChip"><span class="stepNo">2</span>å†èª­ã¿è¾¼ã¿ï¼ˆè‡ªå‹•/æ‰‹å‹•ï¼‰</span>
      <span class="manualChip">â˜…çµ‚äº†å…¥åŠ›æ™‚ï¼šçµ‚äº†ã¯é–‹å§‹ã§è‡ªå‹•å…¥åŠ›</span>
    </div>
    <div class="manualLine">
      <span class="manualChip"><span class="stepNo">3</span>å®´ä¼šæƒ…å ±</span>
      <span class="manualChip"><span class="stepNo">4</span>é–‹å§‹å…¥åŠ›</span>
      <span class="manualChip"><span class="stepNo">5</span>é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰</span>
      <span class="manualChip"><span class="stepNo">6</span>é–‹å§‹ç¢ºå®š</span>
      <span class="manualChip"><span class="stepNo">7</span>çµ‚äº†å…¥åŠ›</span>
      <span class="manualChip"><span class="stepNo">8</span>å®´ä¼šä¿å­˜</span>
    </div>
  </div>
</header>

<main>
  <section id="tab-banquet" class="grid">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">1</span>ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆåº—èˆ—å…±é€šï¼‰</h2>
      <div class="row">
        <div>
          <label>åº—èˆ—å…±é€šãƒ¡ãƒ¼ãƒ«</label>
          <input id="email" type="email" placeholder="ä¾‹ï¼šstore@example.com" />
        </div>
        <div>
          <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input id="pw" type="password" placeholder="********" />
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="btnLogin" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="ghost" id="btnLogout" type="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div class="hr"></div>
      <div id="loginAlert" class="alert">
        <div>âš ï¸</div>
        <div>
          <div style="font-weight:900;">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ / ã‚¨ãƒ©ãƒ¼</div>
          <div id="loginMsg" class="small mono">â€”</div>
          <div id="loginErr" class="small mono dangermsg" style="margin-top:6px; display:none;">â€”</div>
        </div>
      </div>

      <div class="small">â€»ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã¯ <b>è‡ªå‹•ã§â‘¡å†èª­ã¿è¾¼ã¿</b> ã‚’é–‹å§‹ã—ã¾ã™ã€‚</div>
    </div>

    <div class="card" id="reloadCard" style="display:none;">
      <h2 style="margin:0 0 10px; font-size:15px;"><span class="stepNo">2</span>ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿ï¼ˆè‡ªå‹•/æ‰‹å‹•ï¼‰</h2>
      <div class="lockNote">
        <div style="flex:0 0 auto;">âš ï¸</div>
        <div>
          <div style="font-weight:900; margin-bottom:4px;">â‘¡ãŒå®Œäº†ã™ã‚‹ã¾ã§â‘¢ä»¥é™ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚</div>
          <div class="small">ï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ã€å†è©¦è¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</div>
        </div>
      </div>
      <div class="btnbar">
        <button class="primary" id="btnReloadRetry" type="button">å†è©¦è¡Œ</button>
      </div>
      <div id="reloadMsg" class="small mono" style="margin-top:8px;">â€”</div>
    </div>

    <div id="appArea" class="grid locked">

      <div class="card" id="draftCard">
        <div class="draftRow">
          <div>
            <h2 style="margin:0 0 6px; font-size:15px;">ä¸‹æ›¸ãï¼ˆå®´ä¼šï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆ</h2>
            <div class="small">åŒæ™‚ã«2å®´ä¼šãŒèµ°ã‚‹æ™‚ã¯ã€Œæ–°è¦ä¸‹æ›¸ãã€ã‚’2ã¤ä½œã£ã¦åˆ‡ã‚Šæ›¿ãˆã€‚</div>
          </div>
          <div class="btnbar" style="margin-top:0;">
            <button class="primary" id="btnNewDraft" type="button">ï¼‹ æ–°è¦ä¸‹æ›¸ã</button>
            <button class="ghost" id="btnDupDraft" type="button">è¤‡è£½</button>
            <button class="danger" id="btnDelDraft" type="button">ä¸‹æ›¸ãå‰Šé™¤</button>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div>
            <label>ç¾åœ¨ã®ä¸‹æ›¸ãID</label>
            <div class="pill mono" id="currentDraftKey">â€”</div>
          </div>
          <div>
            <label>ç¾åœ¨ã®ä¸‹æ›¸ãï¼ˆæ¦‚è¦ï¼‰</label>
            <div class="pill" id="currentDraftSummary">â€”</div>
          </div>
        </div>

        <div class="draftList" id="draftList"></div>
        <div class="small" id="noDraftsHint" style="display:none;">ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œæ–°è¦ä¸‹æ›¸ãã€ã‚’ä½œã£ã¦ãã ã•ã„ã€‚</div>

        <div class="small" style="margin-top:10px;">
          â€»ã€Œä¸‹æ›¸ãå‰Šé™¤ã€ã¯ <b>2æ®µéš</b><br>
          â€»åŸºæœ¬ã¯ <b>è‡ªå‹•åŒæœŸ</b>ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
        </div>
      </div>

      <div id="remoteBanner" class="alert" style="display:none;">
        <div>ğŸ”</div>
        <div style="width:100%;">
          <div style="font-weight:900;">ä»–ç«¯æœ«ã§ã€Œç¾åœ¨ã®ä¸‹æ›¸ãã€ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ</div>
          <div class="small mono" id="remoteBannerMsg">â€”</div>
          <div class="btnbar" style="margin-top:10px;">
            <button class="primary" id="btnApplyRemote" type="button">åæ˜ ã™ã‚‹</button>
            <button class="ghost" id="btnIgnoreRemote" type="button">ã‚ã¨ã§</button>
          </div>
        </div>
      </div>

      <div class="card" id="metaCard">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <h2 style="margin:0; font-size:15px;"><span class="stepNo">3</span>å®´ä¼š æƒ…å ±</h2>
          <div class="btnbar" style="margin-top:0;">
            <button class="ghost" id="btnMetaReset" type="button">â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
            <button class="ghost" id="btnUnlockMeta" type="button" style="display:none;">â‘¢ã‚’ç·¨é›†ã«æˆ»ã™ï¼ˆâ‘¥å–ã‚Šæ¶ˆã—ï¼‰</button>
          </div>
        </div>
        <div class="small" id="metaLockHint" style="margin-top:6px;">â€”</div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>æ—¥ä»˜</label>
            <input id="evDate" type="date" />
          </div>
          <div>
            <label>äººæ•°</label>
            <input id="evGuests" inputmode="numeric" placeholder="ä¾‹ï¼š30" />
          </div>
          <div>
            <label>é£²ã¿æ”¾é¡Œå˜ä¾¡ï¼ˆå††/äººï¼‰â€»ç¨è¾¼å…¥åŠ›</label>
            <input id="evDrinkPrice" inputmode="numeric" placeholder="ä¾‹ï¼š2500" />
            <div class="small">è¦‹è¾¼ã¿å£²ä¸Šï¼ˆç¨æŠœï¼‰ï¼äººæ•°Ã—(å˜ä¾¡Ã·1.1)</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é£²ã¿æ”¾é¡Œï¼ˆåŸºæœ¬90åˆ† + å»¶é•·30åˆ†å˜ä½ï¼‰</label>
            <div class="row" style="margin:0;">
              <div style="min-width:220px; flex:1;">
                <input id="evExt" inputmode="numeric" placeholder="å»¶é•·å›æ•°ï¼ˆ0ã€œï¼‰ä¾‹ï¼š1" />
                <div class="small">å»¶é•·å›æ•° Ã— 30åˆ†</div>
              </div>
              <div class="kpi" style="flex:1;">
                <div class="t">åˆè¨ˆæ™‚é–“</div>
                <div class="v mono" id="evDuration">90åˆ†</div>
              </div>
            </div>
          </div>

          <div>
            <label>ç€å¸­ / ç«‹é£Ÿ</label>
            <select id="evStyle">
              <option value="seated">ç€å¸­</option>
              <option value="standing">ç«‹é£Ÿ</option>
            </select>
          </div>

          <div>
            <label>ãƒãƒ¼ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ‹…å½“è€…ï¼ˆ1ã€œ2åã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="evStaff" placeholder="ä¾‹ï¼šå±±ç”°, ä½è—¤" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="kpiGrid">
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿åŸä¾¡ï¼ˆçµ‚äº†å…¥åŠ›åˆ†ã®ã¿ï¼‰</div>
            <div class="v mono" id="kpiThisCost">Â¥0</div>
            <div class="small" id="kpiMissingEnds">æœªå…¥åŠ› 0</div>
          </div>
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿å£²ä¸Šï¼ˆç¨æŠœï¼šäººæ•°Ã—(å˜ä¾¡Ã·1.1)ï¼‰</div>
            <div class="v mono" id="kpiThisSales">â€”</div>
            <div class="small" id="kpiSalesHint">äººæ•°ã¨å˜ä¾¡ã‚’å…¥ã‚Œã‚‹ã¨è¨ˆç®—ï¼ˆç¨æŠœï¼‰</div>
          </div>
          <div class="kpi">
            <div class="t">è¦‹è¾¼ã¿åŸä¾¡ç‡ï¼ˆåŸä¾¡Ã·å£²ä¸Šï¼‰</div>
            <div class="v mono" id="kpiThisCostRate">â€”</div>
            <div class="small" id="kpiThisStatus">çŠ¶æ…‹ï¼šæœªç¢ºå®š</div>
          </div>
          <div class="kpi">
            <div class="t">å•†å“ç‚¹æ•°ï¼ˆä½¿ç”¨æ•°&gt;0ï¼‰</div>
            <div class="v mono" id="kpiThisItems">0</div>
            <div class="small">ä½¿ç”¨æ•°ï¼é–‹å§‹âˆ’çµ‚äº†</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="stageWrap">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span class="dot" id="draftDot"></span>
            <div>
              <div style="font-size:14px; font-weight:900;">é€²è¡Œï¼š<span id="stageLabel">â‘£é–‹å§‹å…¥åŠ›</span></div>
              <div class="small mono" id="draftInfo">ä¸‹æ›¸ãï¼šæœªä¿å­˜</div>
            </div>
          </div>

          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="seg">
              <button id="btnStageStart" class="active" type="button"><span class="stepNo">4</span>é–‹å§‹å…¥åŠ›</button>
              <button id="btnStageEnd" type="button"><span class="stepNo">7</span>çµ‚äº†å…¥åŠ›</button>
            </div>
            <button class="primary" id="btnDraftSave" type="button"><span class="stepNo">5</span>é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰</button>
            <button class="danger" id="btnDraftClearLocal" type="button">ãƒ­ãƒ¼ã‚«ãƒ«é€€é¿ã‚’æ¶ˆã™</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnbar" style="margin-top:0;">
          <button class="primary" id="btnConfirmStart" type="button">
            <span class="stepNo">6</span>é–‹å§‹ã‚’ç¢ºå®š â†’ <span class="stepNo">7</span>çµ‚äº†å…¥åŠ›ã¸
          </button>
          <button class="ghost" id="btnBackToStart" type="button" style="display:none;">
            é–‹å§‹ã‚’ç·¨é›†ã—ç›´ã™ï¼ˆçµ‚äº†å…¥åŠ›ã‚’ç ´æ£„ï¼‰
          </button>
          <button class="primary" id="btnFinishEvent" type="button" style="display:none;">
            <span class="stepNo">8</span>å®´ä¼šã‚’å®Œäº†ã—ã¦ä¿å­˜
          </button>
        </div>

        <div class="small" style="margin-top:8px;">
          âœ… â‘¤ã¯ã€Œå¾©å…ƒã€ç”¨ï¼ˆãƒŸã‚¹ã‚¿ãƒƒãƒ—/å†èª­ã¿è¾¼ã¿ã§ã‚‚æ¶ˆãˆãªã„ï¼‰<br>
          âœ… â‘¥é–‹å§‹ç¢ºå®šã§ <b>çµ‚äº†ãŒé–‹å§‹ã§è‡ªå‹•å…¥åŠ›</b>ï¼ˆã“ã“ã‹ã‚‰å®Ÿæ•°èª¿æ•´ï¼‰<br>
          âœ… è¦‹è¾¼ã¿å£²ä¸Šã¯ <b>ç¨æŠœï¼ˆå˜ä¾¡Ã·1.1ï¼‰</b> ã§è¨ˆç®—
        </div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;">
          <div>
            <h2 style="margin:0 0 6px; font-size:15px;"><span class="stepNo">4</span>å•†å“å…¥åŠ›ï¼ˆé–‹å§‹ / çµ‚äº†ï¼‰</h2>
            <div class="small" id="productsHint">é–‹å§‹ãƒ¢ãƒ¼ãƒ‰ï¼šâ‘£å•†å“å…¥åŠ› â†’ â‘¥é–‹å§‹ç¢ºå®š</div>
          </div>
        </div>

        <div class="btnbar" id="bulkStartBar" style="margin-top:8px; display:none;">
          <button class="primary" id="btnFillStartMin" type="button">â‘£ ç›®å®‰ã‚’é–‹å§‹ã«ä¸€æ‹¬å…¥åŠ›</button>
          <span class="small">â€»OK=ç›®å®‰ã§ä¸Šæ›¸ã / ã‚­ãƒ£ãƒ³ã‚»ãƒ«=0ã®ã‚‚ã®ã ã‘ç›®å®‰å…¥åŠ›</span>
        </div>

        <div class="hr"></div>
        <div id="products" class="list"></div>
        <div id="noProducts" class="small">å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚ã€Œå•†å“ãƒã‚¹ã‚¿ã€ã‚¿ãƒ–ã§å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; font-size:15px;">å®´ä¼šä¸€è¦§ï¼ˆä¿å­˜æ¸ˆã¿ï¼‰ï¼‹ç´¯è¨ˆ</h2>
        <div class="row">
          <div><label>ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé–‹å§‹æ—¥ï¼‰</label><input id="fFrom" type="date" /></div>
          <div><label>ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆçµ‚äº†æ—¥ï¼‰</label><input id="fTo" type="date" /></div>
          <div><label>æ“ä½œ</label><div class="btnbar" style="margin-top:0;"><button class="ghost" id="btnClearFilter" type="button">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button></div></div>
        </div>

        <div class="kpiGrid" style="margin-top:10px;">
          <div class="kpi"><div class="t">ç´¯è¨ˆ è¦‹è¾¼ã¿åŸä¾¡ï¼ˆç¢ºå®šã®ã¿ï¼‰</div><div class="v mono" id="kpiSumCostComplete">Â¥0</div><div class="small">æœªå…¥åŠ›ãŒç„¡ã„å®´ä¼šã®ã¿</div></div>
          <div class="kpi"><div class="t">ç´¯è¨ˆ è¦‹è¾¼ã¿å£²ä¸Šï¼ˆç¢ºå®šã®ã¿ / ç¨æŠœï¼‰</div><div class="v mono" id="kpiSumSalesComplete">Â¥0</div><div class="small">äººæ•°Ã—(å˜ä¾¡Ã·1.1)ï¼ˆæœªå…¥åŠ›ã¯é™¤å¤–ï¼‰</div></div>
          <div class="kpi"><div class="t">ç´¯è¨ˆ åŸä¾¡ç‡ï¼ˆç¢ºå®šã®ã¿ï¼‰</div><div class="v mono" id="kpiSumCostRateComplete">â€”</div><div class="small">åŸä¾¡Ã·å£²ä¸Š</div></div>
          <div class="kpi"><div class="t">ç´¯è¨ˆ äººæ•° / å¹³å‡ï¼ˆåŸä¾¡/äººï¼‰</div><div class="v mono" id="kpiSumGuests">0</div><div class="small mono" id="kpiAvgPerHead">â€”</div></div>
        </div>

        <div class="hr"></div>
        <div id="events" class="list"></div>
        <div id="noEvents" class="small">ã¾ã å®´ä¼šãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>

    </div>
  </section>

  <section id="tab-master" class="grid" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">å•†å“ãƒã‚¹ã‚¿ï¼ˆç«¯æœ«é–“åŒæœŸï¼‰</h2>
      <div class="row">
        <div><label>å•†å“å</label><input id="mName" placeholder="ä¾‹ï¼šç”Ÿãƒ“ãƒ¼ãƒ« / ãƒã‚¤ãƒœãƒ¼ãƒ« / ãƒ¯ã‚¤ãƒ³èµ¤" /></div>
        <div><label>å˜ä½ï¼ˆä¾‹ï¼šæœ¬/æ¨½/ç¼¶ï¼‰</label><input id="mUnit" placeholder="ä¾‹ï¼šæœ¬" /></div>
      </div>
      <div class="row">
        <div><label>ä»•å…¥å˜ä¾¡ï¼ˆå††/1å˜ä½ï¼‰</label><input id="mCost" inputmode="numeric" placeholder="ä¾‹ï¼š4800" /></div>
        <div>
          <label>æœ€ä½ç”¨æ„æ•°ï¼ˆç›®å®‰ï¼‰</label>
          <input id="mMin" inputmode="decimal" placeholder="ä¾‹ï¼š6ï¼ˆ0.1åˆ»ã¿OKï¼‰" />
          <div class="small">é–‹å§‹å…¥åŠ›ã®ã€Œç›®å®‰ä¸€æ‹¬å…¥åŠ›ã€ã«ä½¿ã„ã¾ã™ã€‚</div>
        </div>
      </div>
      <div class="row">
        <div><label>ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</label><input id="mCat" placeholder="ä¾‹ï¼šBEER / WHISKY / WINE / SOFT" /></div>
        <div><label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label><input id="mNote" placeholder="ä¾‹ï¼š20Læ¨½ / 700mlãƒœãƒˆãƒ«" /></div>
      </div>
      <div class="btnbar">
        <button class="primary" id="btnAddMaster" type="button">ãƒã‚¹ã‚¿ã«è¿½åŠ </button>
        <button class="primary" id="btnSaveMaster" type="button">ãƒã‚¹ã‚¿ã‚’ä¿å­˜ï¼ˆåŒæœŸï¼‰</button>
      </div>
      <div class="small">â€»ãƒã‚¹ã‚¿ã¯ä¿å­˜ï¼ˆåŒæœŸï¼‰ã™ã‚‹ã¾ã§ä»–ç«¯æœ«ã«åæ˜ ã•ã‚Œã¾ã›ã‚“ã€‚</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">ç™»éŒ²æ¸ˆã¿ãƒã‚¹ã‚¿ï¼ˆç·¨é›†OKï¼‰</h2>
      <div class="small">ã€Œç·¨é›†ã€â†’å†…å®¹å¤‰æ›´â†’ã€Œæ›´æ–°ã€ï¼ˆå¿…è¦ãªã‚‰ã€Œæ›´æ–°ã—ã¦åŒæœŸã€ï¼‰</div>
      <div class="hr"></div>
      <div id="masterList" class="list"></div>
      <div id="noMaster" class="small">ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚</div>
    </div>
  </section>

  <section id="tab-sync" class="grid" style="display:none;">
    <div class="card">
      <h2 style="margin:0 0 10px; font-size:15px;">åŒæœŸ/ãƒ­ã‚°</h2>
      <div class="row">
        <div class="pill">Realtime: <b id="rtState">â€”</b></div>
        <div class="pill">drafts loaded: <b id="draftsCount">0</b></div>
        <div class="pill">events loaded: <b id="eventsCount">0</b></div>
      </div>
      <div class="btnbar">
        <button class="ghost" id="btnDump" type="button">å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°ã«å‡ºã™</button>
      </div>
      <div class="hr"></div>
      <div class="small">ãƒ­ã‚°</div>
      <pre id="log" class="mono" style="white-space:pre-wrap; background:var(--input-bg); border:1px solid var(--line); padding:12px; border-radius:14px; margin:0;">-</pre>
    </div>
  </section>
</main>

<script>
/**
 * Sample U ä¿®æ­£ç‚¹ï¼ˆã“ã®ç‰ˆï¼‰
 * - ã€Œæ–°è¦ä¸‹æ›¸ãã€ãŒç„¡åå¿œ â†’ btnNewDraft / btnDupDraft / btnDelDraft ã‚’å®Ÿè£…
 * - IDã‚ºãƒ¬ã§ã‚‚è½ã¡ãªã„ï¼ˆnull-safe onï¼‰
 * - CSS.escape éå¯¾å¿œã®å¤ã„Safariå¯¾ç­–
 * - â‘¥å–ã‚Šæ¶ˆã—ï¼ˆbtnUnlockMetaï¼‰ã‚‚æœ‰åŠ¹åŒ–
 * - â˜…è¨ˆç®—å¤‰æ›´ï¼šé£²ã¿æ”¾é¡Œå˜ä¾¡ã¯ç¨è¾¼å…¥åŠ›ã®ã¾ã¾ï¼è¦‹è¾¼ã¿å£²ä¸Šã¯ç¨æŠœï¼ˆå˜ä¾¡Ã·1.1ï¼‰ã§è¨ˆç®—
 */
(() => {
  const SUPABASE_URL = "https://pftjjrluhdbovoaxnykn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmdGpqcmx1aGRib3ZvYXhueWtuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExMzUzMTUsImV4cCI6MjA4NjcxMTMxNX0.qX-LpvYcbu589h96FdxJmUEqYto64wniBcuGXraJaoU";

  const DRAFT_KIND = "event_draft";
  const MASTER_KIND = "master";
  const EVENT_KIND = "event";

  const THEME_KEY = "banquet_theme";
  const DID_KEY = "banquet_device_id";
  const ACTIVE_DRAFT_KEY = "banquet_active_draft_key_q";
  const LOCAL_DRAFT_PREFIX = "banquet_draft_q_"; // + draftKey

  const AUTO_DRAFT_SYNC = true;
  const AUTO_SYNC_DEBOUNCE_MS = 1300;
  const AUTO_SYNC_FORCE_MS = 12000;
  const REMOTE_APPLY_GUARD_MS = 1100;

  // â˜…æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰å›ºå®šï¼šç¨è¾¼å…¥åŠ›â†’ç¨æŠœå£²ä¸Šï¼ˆÃ·1.1ï¼‰
  const TAX_RATE = 0.10;
  const TAX_DIV = 1 + TAX_RATE;
  function calcNetSalesYen(guests, grossPerHeadYen){
    if(!guests || guests <= 0) return null;
    if(!grossPerHeadYen || grossPerHeadYen <= 0) return null;
    // äººæ•°Ã—(ç¨è¾¼å˜ä¾¡Ã·1.1) ã‚’å††å˜ä½ã§å››æ¨äº”å…¥
    return Math.round(guests * (grossPerHeadYen / TAX_DIV));
  }

  const $ = (id) => document.getElementById(id);

  // null-safe event binderï¼ˆè¦ç´ ãŒç„¡ãã¦ã‚‚è½ã¡ãªã„ï¼‰
  function on(id, ev, fn){
    const el = $(id);
    if(!el){
      console.warn("missing element:", id);
      return;
    }
    el.addEventListener(ev, fn);
  }

  // CSS.escape ãŒç„¡ã„ç’°å¢ƒå¯¾ç­–ï¼ˆå¤ã„iPad Safariå‘ã‘ï¼‰
  function cssEscape(v){
    const s = String(v ?? "");
    if(window.CSS && typeof CSS.escape === "function") return CSS.escape(s);
    return s.replace(/[^a-zA-Z0-9_-]/g, (m)=>"\\"+m);
  }

  // ===== UI helpers =====
  function showLoginAlert(msg, err){
    const box = $("loginAlert");
    box.classList.add("show");
    $("loginMsg").textContent = msg || "â€”";
    if(err){
      $("loginErr").style.display = "";
      $("loginErr").textContent = String(err);
    }else{
      $("loginErr").style.display = "none";
      $("loginErr").textContent = "â€”";
    }
  }
  function setAppState(t){ $("appState").textContent = t; }

  // ===== global error hookï¼ˆã€Œç„¡åå¿œã€ã‚’æ’²æ»…ï¼‰ =====
  window.addEventListener("error", (e) => {
    const msg = e?.message || "Unknown error";
    const src = e?.filename ? `${e.filename}:${e.lineno||0}` : "";
    showLoginAlert("JSã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ã¾ã—ãŸï¼ˆä¸‹è¨˜ã‚’ç¢ºèªï¼‰", `${msg}${src ? " @ " + src : ""}`);
    setAppState("app: JS error");
  });
  window.addEventListener("unhandledrejection", (e) => {
    const msg = e?.reason?.message || String(e?.reason || "Unhandled rejection");
    showLoginAlert("Promiseã‚¨ãƒ©ãƒ¼ã§åœæ­¢ã—ã¾ã—ãŸï¼ˆä¸‹è¨˜ã‚’ç¢ºèªï¼‰", msg);
    setAppState("app: promise error");
  });

  // ===== Theme =====
  function applyTheme(theme){
    document.documentElement.dataset.theme = theme;
    document.documentElement.style.colorScheme = theme;
    $("btnTheme").innerHTML = theme === "dark"
      ? `ğŸŒ™ <span class="mono" style="font-size:12px;">DARK</span>`
      : `â˜€ï¸ <span class="mono" style="font-size:12px;">LIGHT</span>`;
    localStorage.setItem(THEME_KEY, theme);
  }

  function refreshNet(){
    $("netState").textContent = navigator.onLine ? "ğŸŸ¢ online" : "ğŸ”´ offline";
  }

  function getOrCreateDeviceId(){
    let did = localStorage.getItem(DID_KEY);
    if(!did){
      did = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
      localStorage.setItem(DID_KEY, did);
    }
    return did;
  }

  // ===== Supabase SDK loaderï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ =====
  function loadScript(url){
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = () => resolve(url);
      s.onerror = () => reject(new Error("Failed to load: " + url));
      document.head.appendChild(s);
    });
  }

  async function ensureSupabaseSdk(){
    if(window.supabase && window.supabase.createClient) return "already";
    setAppState("app: loading supabase sdkâ€¦");

    const cdns = [
      "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js",
      "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js",
    ];

    let lastErr = null;
    for(const url of cdns){
      try{
        await loadScript(url);
        if(window.supabase && window.supabase.createClient){
          setAppState("app: sdk loaded");
          return url;
        }
      }catch(e){
        lastErr = e;
      }
    }
    throw lastErr || new Error("Supabase SDK load failed");
  }

  // ===== App main =====
  let sb = null;

  function log(msg, obj){
    const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${JSON.stringify(obj,null,2)}` : "");
    const el = $("log");
    if(el) el.textContent = line + "\n\n" + el.textContent;
  }

  function yen(n){ const v = Math.round((n || 0)); return "Â¥" + v.toLocaleString("ja-JP"); }
  function pct(n){ if(!Number.isFinite(n)) return "â€”"; return (n*100).toFixed(1) + "%"; }
  function parseIntSafe(v){ const s = String(v ?? "").replace(/,/g,"").trim(); if(!s) return null; const n = Number(s); return Number.isFinite(n) ? Math.trunc(n) : null; }
  function parseNumberSafe(v){ const s = String(v ?? "").replace(/,/g,"").trim(); if(s === "") return null; const n = Number(s); return Number.isFinite(n) ? n : null; }
  function to10(x){ return Math.round(Number(x||0) * 10); }
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }
  function todayISO(){
    const d = new Date();
    const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return z.toISOString().slice(0,10);
  }
  function scrollToMetaCard(){ $("metaCard")?.scrollIntoView({ behavior:"smooth", block:"start" }); }
  function isoLater(a,b){
    if(!a) return false;
    if(!b) return true;
    return String(a) > String(b);
  }

  function setSyncState(state, level){
    const dot = $("syncDot");
    dot.classList.remove("ok","run","bad");
    if(level==="ok") dot.classList.add("ok");
    else if(level==="run") dot.classList.add("run");
    else if(level==="bad") dot.classList.add("bad");
    $("syncState").textContent = state;
  }

  // ===== Tabs =====
  function showTab(tab){
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(x => { if(x.dataset.tab === tab) x.classList.add("active"); });
    ["banquet","master","sync"].forEach(k => { $("tab-"+k).style.display = (k === tab) ? "" : "none"; });
    if(tab === "master") renderMaster();
  }
  function bindTabs(){
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => { if(btn.classList.contains("disabled")) return; showTab(btn.dataset.tab); });
    });
  }

  // ===== â‘¡å†èª­ã¿è¾¼ã¿ãƒ­ãƒƒã‚¯ =====
  let mustReload = true;
  let autoReloadInProgress = false;

  function setMustReload(on){
    mustReload = !!on;
    $("reloadCard").style.display = mustReload ? "" : "none";
    $("appArea").classList.toggle("locked", mustReload);
    $("tabBtnMaster").classList.toggle("disabled", mustReload);
    $("tabBtnSync").classList.toggle("disabled", mustReload);
  }
  function setReloadMsg(t){ $("reloadMsg").textContent = t || "â€”"; }
  function setReloadBusy(b, t){
    $("btnReloadRetry").disabled = !!b;
    setReloadMsg(t || (b ? "å†èª­ã¿è¾¼ã¿ä¸­â€¦" : "â€”"));
  }

  // ===== State =====
  let master = { version:1, items:[] };
  let events = [];
  let drafts = [];
  let currentDraftKey = null;
  let pendingRemoteDraft = null;

  let stage = "start";
  let start10 = {};
  let end10 = {};
  let draftSavedAt = null;
  let draftSavedBy = null;
  let draftServerUpdatedAt = null;
  let draftDirty = false;

  let armedDeleteDraftKey = null;
  let armedDeleteDraftTimer = null;
  let armedDeleteEventKey = null;
  let armedDeleteEventTimer = null;

  let rtChannel = null;
  let editingMasterId = null;

  let lastLocalEditAt = 0;
  let autoSyncTimer = null;
  let autoSyncInFlight = false;
  let lastSyncError = null;

  let kpiRAF = 0;
  function scheduleKpis(){
    if(kpiRAF) return;
    kpiRAF = requestAnimationFrame(() => {
      kpiRAF = 0;
      updateAllKpisNow();
      updateCurrentDraftSummaryUI();
    });
  }
  let eventsRAF = 0;
  function scheduleEventsRender(){
    if(eventsRAF) return;
    eventsRAF = requestAnimationFrame(() => {
      eventsRAF = 0;
      renderEventsNow();
    });
  }

  let localSaveTimer = null;
  function scheduleLocalDraftSave(){
    if(!currentDraftKey) return;
    clearTimeout(localSaveTimer);
    localSaveTimer = setTimeout(() => {
      localStorage.setItem(LOCAL_DRAFT_PREFIX + currentDraftKey, JSON.stringify(buildDraftPayload()));
    }, 350);
  }

  // ===== Auth wrappersï¼ˆsbæœªåˆæœŸåŒ–ã§ã‚‚ç„¡åå¿œã«ã—ãªã„ï¼‰ =====
  async function getUser(){
    if(!sb) return null;
    const { data } = await sb.auth.getUser();
    return data?.user || null;
  }
  async function refreshAuthState(){
    const u = await getUser();
    $("authState").textContent = u ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${u.email || "(no email)"}` : "æœªãƒ­ã‚°ã‚¤ãƒ³";
    return u;
  }

  // ===== Master / Draft / Events =====
  let masterRowEnsured = false;

  async function ensureMasterRow(){
    const u = await getUser();
    if(!u) throw new Error("not logged in");
    if(masterRowEnsured) return { payload: master };

    const { data, error } = await sb
      .from("docs")
      .select("payload")
      .eq("kind", MASTER_KIND)
      .eq("doc_key","main")
      .maybeSingle();

    if(error) throw error;

    if(!data){
      const seed = { version:1, items:[] };
      const ins = await sb
        .from("docs")
        .insert({ user_id:u.id, kind:MASTER_KIND, doc_key:"main", payload:seed })
        .select("payload")
        .single();
      if(ins.error) throw ins.error;
      masterRowEnsured = true;
      return ins.data;
    }
    masterRowEnsured = true;
    return data;
  }

  function normalizeMaster(){
    master = master || { version:1, items:[] };
    master.items = (master.items || []).map(it => {
      const min10 = Number.isFinite(Number(it.min10)) ? Math.max(0, Math.trunc(it.min10)) : 0;
      return { ...it, min10 };
    });
  }

  function initQtyMaps(){
    const s = {};
    const e = {};
    (master.items || []).forEach(it => {
      s[it.id] = (start10[it.id] ?? 0);
      e[it.id] = (end10[it.id] === undefined) ? null : end10[it.id];
    });
    start10 = { ...s };
    end10 = { ...e };
  }

  function autoFillEndFromStart(force=false){
    if(stage !== "end") return;
    const items = master.items || [];
    for(const it of items){
      const s10 = start10[it.id] || 0;
      const cur = end10[it.id];
      if(force || cur === null || cur === undefined){
        end10[it.id] = s10;
      }
    }
  }

  async function loadMaster(){
    const u = await getUser();
    if(!u) return;
    const row = await ensureMasterRow();
    master = row.payload || { version:1, items:[] };
    normalizeMaster();
    initQtyMaps();
    autoFillEndFromStart(false);
    renderMaster();
    renderProductsFull();
    scheduleKpis();
  }

  async function saveMaster(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    normalizeMaster();

    const { error } = await sb
      .from("docs")
      .upsert({ user_id:u.id, kind:MASTER_KIND, doc_key:"main", payload:master }, { onConflict:"user_id,kind,doc_key" });

    if(error){
      log("saveMaster error", error);
      return alert("ãƒã‚¹ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
    }
    alert("ãƒã‚¹ã‚¿ã‚’ä¿å­˜ã—ã¦åŒæœŸã—ã¾ã—ãŸ");
  }

  function setActiveDraftKey(key){
    currentDraftKey = key;
    if(key) localStorage.setItem(ACTIVE_DRAFT_KEY, key);
    $("currentDraftKey").textContent = key || "â€”";
    updateCurrentDraftSummaryUI();
    renderDraftList();
  }
  function getActiveDraftKeyFromStorage(){
    return localStorage.getItem(ACTIVE_DRAFT_KEY) || null;
  }
  function clearLocalDraftForKey(key){
    if(!key) return;
    localStorage.removeItem(LOCAL_DRAFT_PREFIX + key);
  }
  function loadLocalDraftForKey(key){
    if(!key) return null;
    const raw = localStorage.getItem(LOCAL_DRAFT_PREFIX + key);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }

  async function loadDraftList(){
    const u = await getUser();
    if(!u) return;

    const { data, error } = await sb
      .from("docs")
      .select("doc_key, payload, updated_at")
      .eq("kind", DRAFT_KIND)
      .order("updated_at", { ascending:false })
      .limit(50);

    if(error){
      log("loadDraftList error", error);
      drafts = [];
      $("draftsCount").textContent = "0";
      return;
    }
    drafts = data || [];
    $("draftsCount").textContent = String(drafts.length);
    renderDraftList();
  }

  function briefDraftSummary(payload){
    if(!payload) return "â€”";
    const m = payload.meta || {};
    const date = m.date || "-";
    const guests = (m.guests ?? null) ? `${m.guests}å` : "äººæ•°â€”";
    const per = (m.drinkPricePerHeadYen ?? null) ? `å˜ä¾¡Â¥${Number(m.drinkPricePerHeadYen).toLocaleString("ja-JP")}ç¨è¾¼` : "å˜ä¾¡â€”";
    const staff = (m.staff || []).join("/") || "æ‹…å½“â€”";
    const st = payload.stage === "end" ? "çµ‚äº†å…¥åŠ›" : "é–‹å§‹å…¥åŠ›";
    return `${date} / ${guests} / ${per} / ${staff} / ${st}`;
  }

  function updateCurrentDraftSummaryUI(){
    if(!currentDraftKey){
      $("currentDraftSummary").textContent = "â€”";
      return;
    }
    $("currentDraftSummary").textContent = briefDraftSummary(buildDraftPayload(false));
  }

  function disarmDraftDelete(){
    armedDeleteDraftKey = null;
    clearTimeout(armedDeleteDraftTimer);
    armedDeleteDraftTimer = null;
    renderDraftList();
  }

  function renderDraftList(){
    const box = $("draftList");
    box.innerHTML = "";
    $("noDraftsHint").style.display = drafts.length ? "none" : "";

    for(const d of drafts){
      const isActive = (d.doc_key === currentDraftKey);
      const armed = (armedDeleteDraftKey === d.doc_key);
      const payload = d.payload || {};
      const summary = briefDraftSummary(payload);
      const upd = d.updated_at || "-";
      const savedAt = payload.savedAt || "-";
      const by = payload.savedBy || "-";

      const el = document.createElement("div");
      el.className = "draftItem" + (isActive ? " active" : "");
      el.innerHTML = `
        <div style="min-width:260px;">
          <div style="font-weight:900; font-size:13px;">${isActive ? "âœ… " : ""}ä¸‹æ›¸ã</div>
          <div class="small">${escapeHtml(summary)}</div>
          <div class="small mono">key=${escapeHtml(d.doc_key)}</div>
          <div class="small mono">updated=${escapeHtml(upd)} / savedAt=${escapeHtml(savedAt)} / by=${escapeHtml(by)}</div>
          ${armed ? `<div class="small" style="margin-top:6px;color:var(--warn);">âš  7ç§’ä»¥å†…ã«ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨å‰Šé™¤</div>` : ``}
        </div>

        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="primary" data-act="open" data-key="${escapeHtml(d.doc_key)}" type="button">${isActive ? "è¡¨ç¤ºä¸­" : "åˆ‡æ›¿"}</button>
          <button class="ghost" data-act="dup" data-key="${escapeHtml(d.doc_key)}" type="button">è¤‡è£½</button>
          <button class="${armed ? "danger" : "ghost"}" data-act="del" data-key="${escapeHtml(d.doc_key)}" type="button">${armed ? "ã‚‚ã†ä¸€åº¦ã§å‰Šé™¤" : "å‰Šé™¤"}</button>
        </div>
      `;

      el.querySelector('[data-act="open"]').addEventListener("click", async () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        const key = d.doc_key;
        if(key === currentDraftKey) return;

        if(draftDirty && navigator.onLine){
          await saveRemoteDraftNow(true, "switch-pre");
        }else{
          scheduleLocalDraftSave();
        }

        const ok = await switchToDraft(key);
        if(ok) scrollToMetaCard();
      });

      el.querySelector('[data-act="dup"]').addEventListener("click", async () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        await duplicateDraft(d.doc_key);
      });

      el.querySelector('[data-act="del"]').addEventListener("click", async () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        const key = d.doc_key;
        if(armedDeleteDraftKey !== key){
          disarmDraftDelete();
          armedDeleteDraftKey = key;
          armedDeleteDraftTimer = setTimeout(disarmDraftDelete, 7000);
          renderDraftList();
          return;
        }
        disarmDraftDelete();
        if(!confirm("ã“ã®ä¸‹æ›¸ãã‚’Supabaseã‹ã‚‰å®Œå…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        await deleteDraft(key);
      });

      box.appendChild(el);
    }
  }

  async function fetchDraftByKey(key){
    const { data, error } = await sb
      .from("docs")
      .select("payload, updated_at")
      .eq("kind", DRAFT_KIND)
      .eq("doc_key", key)
      .maybeSingle();
    if(error) throw error;
    if(!data) return null;
    return { payload: data.payload, updated_at: data.updated_at };
  }

  async function switchToDraft(key){
    const u = await getUser();
    if(!u) { alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦"); return false; }

    const remote = await fetchDraftByKey(key);
    const local = loadLocalDraftForKey(key);

    if(!remote && !local){
      alert("ä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ï¼‰");
      return false;
    }

    if(remote && local){
      const remoteAt = remote.payload?.savedAt || null;
      const localAt = local.savedAt || null;
      setActiveDraftKey(key);

      if(isoLater(localAt, remoteAt)){
        applyDraftPayload(local, "ãƒ­ãƒ¼ã‚«ãƒ«(æ–°)â†’åŒæœŸå¾…ã¡");
        draftDirty = true;
        scheduleAutoDraftSync("local newer");
      }else{
        applyDraftPayload(remote.payload, "remoteé©ç”¨");
        draftServerUpdatedAt = remote.updated_at || null;
      }
      return true;
    }

    setActiveDraftKey(key);
    if(remote){
      applyDraftPayload(remote.payload, "remoteé©ç”¨");
      draftServerUpdatedAt = remote.updated_at || null;
      return true;
    }
    if(local){
      applyDraftPayload(local, "ãƒ­ãƒ¼ã‚«ãƒ«é©ç”¨");
      draftDirty = true;
      scheduleAutoDraftSync("local only");
      return true;
    }
    return false;
  }

  function buildBlankDraftPayload(){
    const now = new Date().toISOString();
    return {
      version:1,
      stage:"start",
      meta:{
        date: todayISO(),
        guests: null,
        drinkPricePerHeadYen: null,
        salesYen: null,
        extensionCount: 0,
        durationMin: 90,
        style: "seated",
        staff: []
      },
      start10:{},
      end10:{},
      savedAt: now,
      savedBy: getOrCreateDeviceId()
    };
  }

  async function createNewDraft(andSwitch=true){
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
    const key = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
    const payload = buildBlankDraftPayload();
    const { error } = await sb.from("docs").insert({ user_id:u.id, kind:DRAFT_KIND, doc_key:key, payload });
    if(error){
      log("createNewDraft error", error);
      return alert("æ–°è¦ä¸‹æ›¸ãä½œæˆã«å¤±æ•—: " + error.message);
    }
    await loadDraftList();
    if(andSwitch){
      await switchToDraft(key);
      scrollToMetaCard();
    }
  }

  async function duplicateDraft(fromKey){
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
    const src = await fetchDraftByKey(fromKey);
    if(!src?.payload) return alert("è¤‡è£½å…ƒã®ä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

    const key = crypto.randomUUID ? crypto.randomUUID() : String(Date.now());
    const copy = JSON.parse(JSON.stringify(src.payload));
    copy.savedAt = new Date().toISOString();
    copy.savedBy = getOrCreateDeviceId();

    const { error } = await sb.from("docs").insert({ user_id:u.id, kind:DRAFT_KIND, doc_key:key, payload:copy });
    if(error){
      log("duplicateDraft error", error);
      return alert("è¤‡è£½ã«å¤±æ•—: " + error.message);
    }
    await loadDraftList();
    await switchToDraft(key);
    scrollToMetaCard();
  }

  async function deleteDraft(key){
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    const { error } = await sb
      .from("docs")
      .delete()
      .eq("kind", DRAFT_KIND)
      .eq("doc_key", key)
      .eq("user_id", u.id);

    if(error){
      log("deleteDraft error", error);
      return alert("ä¸‹æ›¸ãå‰Šé™¤ã«å¤±æ•—: " + error.message);
    }
    clearLocalDraftForKey(key);

    await loadDraftList();

    if(key === currentDraftKey){
      const next = drafts[0]?.doc_key || null;
      if(next){
        await switchToDraft(next);
      }else{
        setActiveDraftKey(null);
        await createNewDraft(true);
      }
    }
    alert("ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  function buildDraftPayload(updateMetaSales=true){
    const guests = parseIntSafe($("evGuests").value);
    const per = parseIntSafe($("evDrinkPrice").value);

    // â˜…ç¨æŠœå£²ä¸Š
    const salesYen = calcNetSalesYen(guests, per);

    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    const durationMin = 90 + 30*ext;

    const style = $("evStyle").value;
    const staff = ($("evStaff").value || "").split(",").map(s=>s.trim()).filter(Boolean).slice(0,2);

    const now = new Date().toISOString();
    return {
      version:1,
      stage,
      meta:{
        date: $("evDate").value || todayISO(),
        guests: guests ?? null,
        drinkPricePerHeadYen: per ?? null, // å…¥åŠ›ã¯ç¨è¾¼ã®ã¾ã¾ä¿æŒ
        salesYen: updateMetaSales ? salesYen : null, // ä¿å­˜ã•ã‚Œã‚‹å£²ä¸Šã¯ç¨æŠœ
        extensionCount: ext,
        durationMin,
        style,
        staff
      },
      start10,
      end10,
      savedAt: now,
      savedBy: getOrCreateDeviceId()
    };
  }

  function applyDraftPayload(p, why){
    if(!p || typeof p !== "object") return;

    stage = (p.stage === "end") ? "end" : "start";

    const m = p.meta || {};
    $("evDate").value = m.date || todayISO();
    $("evGuests").value = (m.guests ?? "") === null ? "" : String(m.guests ?? "");
    $("evDrinkPrice").value = (m.drinkPricePerHeadYen ?? "") === null ? "" : String(m.drinkPricePerHeadYen ?? "");
    $("evExt").value = String(m.extensionCount ?? 0);
    $("evStyle").value = m.style || "seated";
    $("evStaff").value = (m.staff || []).join(", ");

    start10 = (p.start10 && typeof p.start10 === "object") ? p.start10 : {};
    end10   = (p.end10 && typeof p.end10 === "object") ? p.end10 : {};

    draftSavedAt = p.savedAt || null;
    draftSavedBy = p.savedBy || null;
    draftDirty = false;

    initQtyMaps();
    autoFillEndFromStart(false);

    updateDurationUI();
    updateStageUI();
    renderProductsFull();
    scheduleKpis();
    updateDraftInfoUI(why || "é©ç”¨");
    scheduleLocalDraftSave();

    hideRemoteBanner();
  }

  function updateDraftInfoUI(extra){
    const dot = $("draftDot");
    const label = $("draftInfo");
    const saved = draftSavedAt ? `savedAt ${draftSavedAt}` : "æœªä¿å­˜";
    const by = draftSavedBy ? ` / by ${draftSavedBy}` : "";
    const server = draftServerUpdatedAt ? ` / server ${draftServerUpdatedAt}` : "";
    const dirty = draftDirty ? " / *dirty" : "";
    label.textContent = `ä¸‹æ›¸ã(${currentDraftKey||"â€”"}): ${saved}${by}${server}${dirty}` + (extra ? ` / ${extra}` : "");

    dot.classList.remove("ok","run","bad");
    if(stage === "end") dot.classList.add("run");
    if(!draftDirty && draftSavedAt) dot.classList.add("ok");
    if(draftDirty && lastSyncError) dot.classList.add("bad");
  }

  async function canSyncDraft(){
    if(!AUTO_DRAFT_SYNC) return false;
    if(mustReload) return false;
    if(!currentDraftKey) return false;
    const u = await getUser();
    return !!u;
  }

  function scheduleAutoDraftSync(reason){
    if(!AUTO_DRAFT_SYNC) return;
    clearTimeout(autoSyncTimer);
    autoSyncTimer = setTimeout(async () => {
      if(!draftDirty) return;
      const ok = await canSyncDraft();
      if(!ok) return;
      if(autoSyncInFlight) return;
      await saveRemoteDraftNow(true, reason || "auto");
    }, AUTO_SYNC_DEBOUNCE_MS);
  }

  setInterval(async () => {
    if(!AUTO_DRAFT_SYNC) return;
    if(!draftDirty) return;
    const ok = await canSyncDraft();
    if(!ok) return;
    if(autoSyncInFlight) return;
    await saveRemoteDraftNow(true, "auto(force)");
  }, AUTO_SYNC_FORCE_MS);

  async function saveRemoteDraftNow(isAuto, reason){
    const u = await getUser();
    if(!u) return;
    if(!currentDraftKey) return;

    if(autoSyncInFlight) return;
    autoSyncInFlight = true;

    const payload = buildDraftPayload(true);
    setSyncState(isAuto ? "ä¸‹æ›¸ãåŒæœŸï¼šåŒæœŸä¸­ï¼ˆè‡ªå‹•ï¼‰" : "ä¸‹æ›¸ãåŒæœŸï¼šåŒæœŸä¸­", "run");
    lastSyncError = null;

    const { data, error } = await sb
      .from("docs")
      .upsert({ user_id:u.id, kind:DRAFT_KIND, doc_key:currentDraftKey, payload }, { onConflict:"user_id,kind,doc_key" })
      .select("updated_at")
      .single();

    if(error){
      autoSyncInFlight = false;
      lastSyncError = error.message || String(error);
      log("saveRemoteDraft error", error);
      setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šå¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜ï¼‰", "bad");
      updateDraftInfoUI("åŒæœŸå¤±æ•—");
      scheduleLocalDraftSave();
      return;
    }

    draftSavedAt = payload.savedAt;
    draftSavedBy = payload.savedBy;
    draftServerUpdatedAt = data?.updated_at || null;
    draftDirty = false;

    updateDraftInfoUI((isAuto ? "è‡ªå‹•åŒæœŸæ¸ˆã¿" : "åŒæœŸæ¸ˆã¿") + (reason ? `(${reason})` : ""));
    setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šåŒæœŸæ¸ˆã¿", "ok");
    scheduleLocalDraftSave();
    autoSyncInFlight = false;

    await loadDraftList();
  }

  function markDraftDirty(reason){
    draftDirty = true;
    lastLocalEditAt = Date.now();
    updateDraftInfoUI(reason ? ("dirty:"+reason) : "dirty");
    scheduleLocalDraftSave();
    scheduleAutoDraftSync(reason);
    if(navigator.onLine) setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šå¾…æ©Ÿä¸­â€¦", "run");
    else setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰", "bad");
  }

  function showRemoteBanner(msg, payload){
    pendingRemoteDraft = payload;
    $("remoteBanner").style.display = "";
    $("remoteBanner").classList.add("show");
    $("remoteBannerMsg").textContent = msg || "â€”";
  }
  function hideRemoteBanner(){
    pendingRemoteDraft = null;
    $("remoteBanner").style.display = "none";
    $("remoteBanner").classList.remove("show");
  }

  function updateDurationUI(){
    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    $("evDuration").textContent = `${90 + 30*ext}åˆ†`;
  }

  function getDraftSalesYen(){
    const guests = parseIntSafe($("evGuests").value);
    const per = parseIntSafe($("evDrinkPrice").value);
    return calcNetSalesYen(guests, per); // â˜…ç¨æŠœ
  }

  function updateBulkBarUI(){
    $("bulkStartBar").style.display = (stage === "start") ? "" : "none";
    $("btnFillStartMin").disabled = mustReload;
  }

  function updateStageUI(){
    $("stageLabel").textContent = (stage==="start") ? "â‘£é–‹å§‹å…¥åŠ›" : "â‘¦çµ‚äº†å…¥åŠ›";
    $("btnStageStart").classList.toggle("active", stage==="start");
    $("btnStageEnd").classList.toggle("active", stage==="end");

    $("btnConfirmStart").style.display = (stage==="start") ? "" : "none";
    $("btnBackToStart").style.display = (stage==="end") ? "" : "none";
    $("btnFinishEvent").style.display = (stage==="end") ? "" : "none";

    $("productsHint").textContent = (stage==="start")
      ? "é–‹å§‹ãƒ¢ãƒ¼ãƒ‰ï¼šâ‘£å•†å“å…¥åŠ› â†’ â‘¥é–‹å§‹ç¢ºå®š"
      : "çµ‚äº†ãƒ¢ãƒ¼ãƒ‰ï¼šé–‹å§‹ã¯å›ºå®šã€‚â‘¦çµ‚äº†å…¥åŠ› â†’ â‘§å®´ä¼šä¿å­˜ï¼ˆçµ‚äº†ã¯é–‹å§‹ã§è‡ªå‹•å…¥åŠ›æ¸ˆã¿ï¼‰";

    const lockMeta = (stage==="end");
    ["evDate","evGuests","evDrinkPrice","evExt","evStyle","evStaff"].forEach(id => { $(id).disabled = lockMeta; });
    $("btnUnlockMeta").style.display = lockMeta ? "" : "none";
    $("btnMetaReset").disabled = lockMeta;

    $("metaLockHint").textContent = lockMeta
      ? "â€»â‘¦çµ‚äº†å…¥åŠ›ä¸­ã®ãŸã‚â‘¢ã¯ãƒ­ãƒƒã‚¯ä¸­ï¼ˆâ‘¥å–ã‚Šæ¶ˆã—ã§é–‹å§‹ã¸æˆ»ã—ã¦ã‹ã‚‰ï¼‰"
      : "â€»â‘¢â†’â‘£â†’â‘¥ã®æµã‚Œã€‚â‘¤ã§é€”ä¸­ä¿å­˜ï¼ˆåŒæœŸï¼‰ã§ãã¾ã™ã€‚";

    updateBulkBarUI();
  }

  function calcAgg(){
    let total = 0;
    let usedItemCount = 0;
    let missingEnds = 0;
    let negativeCount = 0;

    for(const it of (master.items||[])){
      const s10 = start10[it.id] || 0;
      const e10 = end10[it.id];
      if(s10>0 && (e10===null || e10===undefined)) missingEnds++;
      if(e10===null || e10===undefined) continue;

      const used10 = s10 - e10;
      if(used10 < 0) negativeCount++;
      const used = used10/10;
      if(used>0){
        usedItemCount++;
        total += Math.round(used * Number(it.costYen||0));
      }
    }
    return { total, usedItemCount, missingEnds, negativeCount };
  }

  function updateAllKpisNow(){
    const a = calcAgg();
    $("kpiThisCost").textContent = yen(a.total);
    $("kpiThisItems").textContent = String(a.usedItemCount);

    const extraNeg = a.negativeCount ? ` / å¢—åŠ ç–‘ã„ ${a.negativeCount}` : "";
    $("kpiMissingEnds").textContent = `æœªå…¥åŠ› ${a.missingEnds}` + extraNeg;

    const sales = getDraftSalesYen();
    if(sales !== null){
      $("kpiThisSales").textContent = yen(sales);
      $("kpiThisCostRate").textContent = pct(a.total / sales);
      $("kpiSalesHint").textContent = "â€”";
    }else{
      $("kpiThisSales").textContent = "â€”";
      $("kpiThisCostRate").textContent = "â€”";
      $("kpiSalesHint").textContent = "äººæ•°ã¨å˜ä¾¡ã‚’å…¥ã‚Œã‚‹ã¨è¨ˆç®—ï¼ˆç¨æŠœï¼‰";
    }

    $("kpiThisStatus").textContent =
      (stage === "start") ? "çŠ¶æ…‹ï¼šâ‘£é–‹å§‹å…¥åŠ›ä¸­" : (a.missingEnds===0 ? "çŠ¶æ…‹ï¼šç¢ºå®šï¼ˆâ‘§ä¿å­˜å¯ï¼‰" : "çŠ¶æ…‹ï¼šæœªç¢ºå®šï¼ˆçµ‚äº†æœªå…¥åŠ›ã‚ã‚Šï¼‰");
  }

  function usedInfoForItem(it){
    const s10 = start10[it.id] || 0;
    const e10 = end10[it.id];
    const used10 = (e10===null || e10===undefined) ? null : (s10 - e10);
    const usedText = (used10===null) ? "â€”" : (used10/10).toFixed(1);
    const usedClass = (used10===null) ? "missing" : (used10<0 ? "negative" : "");
    return { s10, e10, usedText, usedClass };
  }

  function needWarn(it){
    const min10 = it.min10 || 0;
    const s10 = start10[it.id] || 0;
    return (stage === "start" && min10 > 0 && s10 < min10);
  }

  function renderProductsFull(){
    const items = master.items || [];
    $("noProducts").style.display = items.length ? "none" : "";

    const box = $("products");
    box.innerHTML = "";

    for(const it of items){
      if(start10[it.id]===undefined) start10[it.id]=0;
      if(end10[it.id]===undefined) end10[it.id]=null;

      const info = usedInfoForItem(it);
      const min10 = it.min10 || 0;
      const minText = (min10>0) ? (min10/10).toFixed(1) : "â€”";
      const showWarn = needWarn(it);

      const row = document.createElement("div");
      row.className = "prodRow";
      row.setAttribute("data-itemid", it.id);
      row.innerHTML = `
        <div>
          <div class="prodName">${escapeHtml(it.name)}</div>
          <div class="prodMeta">
            <span>å˜ä¾¡ <span class="mono">${yen(Number(it.costYen||0))}</span></span>
            <span>/ å˜ä½ ${escapeHtml(it.unit||"æœ¬")}</span>
            <span>/ ç›®å®‰ <span class="mono" data-role="minVal">${escapeHtml(minText)}</span></span>
            <span class="badge warn" data-role="minWarn" style="display:${showWarn ? "inline-flex" : "none"};">ç›®å®‰æœªé”</span>
          </div>
        </div>

        <div class="controls" data-itemid="${escapeHtml(it.id)}">
          ${
            stage==="start"
            ? `
              <div class="ctrlBox startBox">
                <div class="ctrlTitle"><span>é–‹å§‹ï¼ˆå…¥åŠ›ï¼‰</span><span class="mono" data-role="startLabel">${(info.s10/10).toFixed(1)}</span></div>
                <div class="ctrlGrid">
                  <div class="stepBtn" data-act="step" data-field="start" data-step="-10">âˆ’1</div>
                  <div class="stepBtn" data-act="step" data-field="start" data-step="-1">âˆ’0.1</div>
                  <input class="qtyInput" data-role="startInput" inputmode="decimal" value="${(info.s10/10).toFixed(1)}" />
                  <div class="stepBtn primary" data-act="step" data-field="start" data-step="1">+0.1</div>
                  <div class="stepBtn primary" data-act="step" data-field="start" data-step="10">+1</div>
                </div>
              </div>
            `
            : `
              <div class="ctrlBox startBox readonly">
                <div class="ctrlTitle"><span>é–‹å§‹ï¼ˆå›ºå®šï¼‰</span><span class="mono" data-role="startLabel">${(info.s10/10).toFixed(1)}</span></div>
                <div class="roQty mono" data-role="startRO">${(info.s10/10).toFixed(1)}</div>
                <div class="small">é–‹å§‹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
              </div>
            `
          }

          ${
            stage==="end"
            ? `
              <div class="ctrlBox endBox">
                <div class="ctrlTitle"><span>çµ‚äº†ï¼ˆå…¥åŠ›ï¼‰</span><span class="mono" data-role="endLabel">${(info.e10===null || info.e10===undefined) ? "â€”" : (info.e10/10).toFixed(1)}</span></div>
                <div class="ctrlGrid">
                  <div class="stepBtn" data-act="step" data-field="end" data-step="-10">âˆ’1</div>
                  <div class="stepBtn" data-act="step" data-field="end" data-step="-1">âˆ’0.1</div>
                  <input class="qtyInput" data-role="endInput" inputmode="decimal" value="${(info.e10===null || info.e10===undefined) ? "" : (info.e10/10).toFixed(1)}" placeholder="â€”" />
                  <div class="stepBtn primary" data-act="step" data-field="end" data-step="1">+0.1</div>
                  <div class="stepBtn primary" data-act="step" data-field="end" data-step="10">+1</div>
                </div>
              </div>
            `
            : `
              <div class="ctrlBox endBox readonly">
                <div class="ctrlTitle"><span>çµ‚äº†ï¼ˆå¾Œã§ï¼‰</span><span class="mono" data-role="endLabel">â€”</span></div>
                <div class="roQty mono">â€”</div>
                <div class="small">â‘¥é–‹å§‹ç¢ºå®šå¾Œã«å…¥åŠ›ã—ã¾ã™</div>
              </div>
            `
          }

          <div class="usedBox">
            <div class="usedLine">ä½¿ç”¨ï¼ˆé–‹å§‹âˆ’çµ‚äº†ï¼‰</div>
            <div class="usedVal ${info.usedClass} mono" data-role="usedVal">${info.usedText}</div>
          </div>
        </div>
      `;
      box.appendChild(row);
    }
  }

  function updateProductRow(itemId){
    const ctrl = document.querySelector(`.controls[data-itemid="${cssEscape(itemId)}"]`);
    if(!ctrl) return;

    const it = (master.items||[]).find(x => x.id === itemId);
    if(!it) return;

    const info = usedInfoForItem(it);

    const startLabel = ctrl.querySelector('[data-role="startLabel"]');
    if(startLabel) startLabel.textContent = (info.s10/10).toFixed(1);

    const startInput = ctrl.querySelector('[data-role="startInput"]');
    if(startInput && stage==="start") startInput.value = (info.s10/10).toFixed(1);

    const startRO = ctrl.querySelector('[data-role="startRO"]');
    if(startRO && stage==="end") startRO.textContent = (info.s10/10).toFixed(1);

    const endLabel = ctrl.querySelector('[data-role="endLabel"]');
    if(endLabel) endLabel.textContent = (info.e10===null || info.e10===undefined) ? "â€”" : (info.e10/10).toFixed(1);

    const endInput = ctrl.querySelector('[data-role="endInput"]');
    if(endInput && stage==="end"){
      endInput.value = (info.e10===null || info.e10===undefined) ? "" : (info.e10/10).toFixed(1);
    }

    const usedVal = ctrl.querySelector('[data-role="usedVal"]');
    if(usedVal){
      usedVal.textContent = info.usedText;
      usedVal.classList.remove("missing","negative");
      if(info.usedClass) usedVal.classList.add(info.usedClass);
    }

    const row = document.querySelector(`.prodRow[data-itemid="${cssEscape(itemId)}"]`);
    if(row){
      const warnEl = row.querySelector('[data-role="minWarn"]');
      if(warnEl){
        warnEl.style.display = needWarn(it) ? "inline-flex" : "none";
      }
    }
  }

  function bindProductsDelegationOnce(){
    const box = $("products");
    box.addEventListener("click", (ev) => {
      if(mustReload) return;
      const btn = ev.target.closest('[data-act="step"]');
      if(!btn) return;

      const ctrl = btn.closest(".controls");
      const itemId = ctrl.getAttribute("data-itemid");
      const step = parseInt(btn.getAttribute("data-step"),10) || 0;
      const field = btn.getAttribute("data-field");

      if(field==="start"){
        if(stage!=="start") return;
        start10[itemId] = Math.max(0, (start10[itemId]||0) + step);
      }else if(field==="end"){
        if(stage!=="end") return;
        const now = (end10[itemId]===null || end10[itemId]===undefined) ? 0 : (end10[itemId]||0);
        end10[itemId] = Math.max(0, now + step);
      }

      updateProductRow(itemId);
      scheduleKpis();
      markDraftDirty("step");
    });

    box.addEventListener("change", (ev) => {
      if(mustReload) return;
      const inp = ev.target.closest(".qtyInput");
      if(!inp) return;

      const ctrl = inp.closest(".controls");
      const itemId = ctrl.getAttribute("data-itemid");
      const role = inp.getAttribute("data-role");
      const val = (inp.value||"").trim();

      if(role==="startInput"){
        if(stage!=="start") return;
        const n = parseNumberSafe(val);
        start10[itemId] = Math.max(0, to10(n||0));
      }else if(role==="endInput"){
        if(stage!=="end") return;
        if(val==="") end10[itemId] = null;
        else{
          const n = parseNumberSafe(val);
          end10[itemId] = Math.max(0, to10(n||0));
        }
      }

      updateProductRow(itemId);
      scheduleKpis();
      markDraftDirty("input");
    });
  }

  function fillStartByMin(overwrite){
    if(stage !== "start") return alert("ç›®å®‰ä¸€æ‹¬å…¥åŠ›ã¯é–‹å§‹ï¼ˆâ‘£ï¼‰ã®ã¨ãã ã‘ä½¿ãˆã¾ã™ã€‚");
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    const items = master.items || [];
    if(!items.length) return alert("å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚");

    let changed = 0;
    let applied = 0;
    for(const it of items){
      const min10 = it.min10 || 0;
      if(min10 <= 0) continue;
      applied++;

      const cur = start10[it.id] || 0;
      if(!overwrite && cur > 0) continue;

      if(cur !== min10){
        start10[it.id] = min10;
        changed++;
      }
    }

    if(applied === 0) return alert("ãƒã‚¹ã‚¿ã®ç›®å®‰ãŒå…¥ã£ã¦ã„ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    if(changed === 0) return alert("å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");

    for(const it of items){
      if((it.min10||0) > 0) updateProductRow(it.id);
    }
    scheduleKpis();
    markDraftDirty("fill min");
    alert(`ç›®å®‰ã‚’é–‹å§‹ã«åæ˜ ã—ã¾ã—ãŸï¼ˆå¤‰æ›´: ${changed} å•†å“ï¼‰`);
  }

  // ===== Master UIï¼ˆã“ã“ä»¥é™ã¯å…ƒã®ã¾ã¾ï¼‰ =====
  function findMasterItem(id){
    return (master.items||[]).find(x => x.id === id) || null;
  }

  function renderMaster(){
    const box = $("masterList");
    box.innerHTML = "";
    const items = master.items || [];
    $("noMaster").style.display = items.length ? "none" : "";

    for(const it of items){
      const min10 = it.min10 || 0;
      const minTxt = (min10>0) ? (min10/10).toFixed(1) : "â€”";
      const isEditing = (editingMasterId === it.id);

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemHeader">
          <div>
            <h3>${escapeHtml(it.name)}</h3>
            <div class="small">
              å˜ä½ï¼š${escapeHtml(it.unit||"æœ¬")}
              / å˜ä¾¡ï¼š<span class="mono">${yen(Number(it.costYen||0))}</span>
              / ç›®å®‰ï¼š<span class="mono">${escapeHtml(minTxt)}</span>
              ${it.category ? `/ ã‚«ãƒ†ã‚´ãƒªï¼š${escapeHtml(it.category)}` : ``}
              ${it.note ? `/ å‚™è€ƒï¼š${escapeHtml(it.note)}` : ``}
            </div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <span class="badge">ID: ${escapeHtml(it.id)}</span>
            <div class="btnbar" style="margin-top:0;">
              <button class="ghost" data-act="edit" type="button">${isEditing ? "ç·¨é›†ã‚’é–‰ã˜ã‚‹" : "ç·¨é›†"}</button>
              <button class="danger" data-act="del" type="button">å‰Šé™¤</button>
            </div>
          </div>
        </div>

        <div class="editBox" style="display:${isEditing ? "" : "none"};">
          <div class="editTitle">ç·¨é›†ï¼ˆã€Œãƒã‚¹ã‚¿ä¿å­˜ï¼ˆåŒæœŸï¼‰ã€ã§ç«¯æœ«é–“åæ˜ ï¼‰</div>
          <div class="row">
            <div><label>å•†å“å</label><input data-edit="name" value="${escapeHtml(it.name)}" /></div>
            <div><label>å˜ä½</label><input data-edit="unit" value="${escapeHtml(it.unit||"æœ¬")}" /></div>
          </div>
          <div class="row">
            <div><label>ä»•å…¥å˜ä¾¡ï¼ˆå††ï¼‰</label><input data-edit="cost" inputmode="numeric" value="${escapeHtml(String(it.costYen ?? 0))}" /></div>
            <div><label>æœ€ä½ç”¨æ„æ•°ï¼ˆç›®å®‰ï¼‰</label><input data-edit="min" inputmode="decimal" value="${escapeHtml(String((it.min10||0)/10))}" /></div>
          </div>
          <div class="row">
            <div><label>ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</label><input data-edit="cat" value="${escapeHtml(it.category||"")}" /></div>
            <div><label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label><input data-edit="note" value="${escapeHtml(it.note||"")}" /></div>
          </div>
          <div class="btnbar">
            <button class="primary" data-act="apply" type="button">æ›´æ–°</button>
            <button class="primary" data-act="applySync" type="button">æ›´æ–°ã—ã¦åŒæœŸ</button>
            <button class="ghost" data-act="cancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      `;

      el.querySelector('[data-act="edit"]').addEventListener("click", () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        editingMasterId = (editingMasterId === it.id) ? null : it.id;
        renderMaster();
      });

      el.querySelector('[data-act="del"]').addEventListener("click", () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        if(!confirm(`ã€Œ${it.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        master.items = master.items.filter(x => x.id !== it.id);
        delete start10[it.id];
        delete end10[it.id];
        initQtyMaps();
        if(editingMasterId === it.id) editingMasterId = null;
        renderMaster();
        renderProductsFull();
        scheduleKpis();
        markDraftDirty("master del");
      });

      const applyEdit = async (doSync) => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        const cur = findMasterItem(it.id);
        if(!cur) return;

        const name = (el.querySelector('[data-edit="name"]').value || "").trim();
        const unit = (el.querySelector('[data-edit="unit"]').value || "").trim() || "æœ¬";
        const costN = parseNumberSafe(el.querySelector('[data-edit="cost"]').value);
        const minN  = parseNumberSafe(el.querySelector('[data-edit="min"]').value);
        const cat   = (el.querySelector('[data-edit="cat"]').value || "").trim();
        const note  = (el.querySelector('[data-edit="note"]').value || "").trim();

        if(!name) return alert("å•†å“åã¯å¿…é ˆã§ã™");
        if(costN === null || costN < 0) return alert("ä»•å…¥å˜ä¾¡ãŒä¸æ­£ã§ã™");
        if(minN !== null && minN < 0) return alert("ç›®å®‰ã¯0ä»¥ä¸Šã«ã—ã¦");

        cur.name = name;
        cur.unit = unit;
        cur.costYen = Math.round(costN);
        cur.min10 = (minN===null) ? (cur.min10||0) : Math.max(0, to10(minN));
        cur.category = cat ? cat : null;
        cur.note = note ? note : null;

        normalizeMaster();
        initQtyMaps();
        autoFillEndFromStart(false);

        renderMaster();
        renderProductsFull();
        scheduleKpis();
        markDraftDirty("master edit");

        if(doSync){
          await saveMaster();
        }else{
          alert("æ›´æ–°ã—ã¾ã—ãŸï¼ˆã¾ã åŒæœŸã¯ã—ã¦ã„ã¾ã›ã‚“ï¼‰");
        }
      };

      el.querySelector('[data-act="apply"]')?.addEventListener("click", () => applyEdit(false));
      el.querySelector('[data-act="applySync"]')?.addEventListener("click", () => applyEdit(true));
      el.querySelector('[data-act="cancel"]')?.addEventListener("click", () => { editingMasterId = null; renderMaster(); });

      box.appendChild(el);
    }
  }

  async function loadEvents(){
    const { data, error } = await sb
      .from("docs")
      .select("doc_key, payload, created_at, updated_at, kind, user_id")
      .eq("kind", EVENT_KIND)
      .order("created_at",{ ascending:false })
      .limit(400);

    if(error){ log("loadEvents error", error); return; }
    events = data || [];
    $("eventsCount").textContent = String(events.length);
    scheduleEventsRender();
  }

  function disarmEventDelete(){
    armedDeleteEventKey = null;
    clearTimeout(armedDeleteEventTimer);
    armedDeleteEventTimer = null;
  }

  async function deleteEvent(docKey){
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
    const { error } = await sb
      .from("docs")
      .delete()
      .eq("kind", EVENT_KIND)
      .eq("doc_key", docKey)
      .eq("user_id", u.id);

    if(error){
      log("deleteEvent error", error);
      return alert("å‰Šé™¤ã«å¤±æ•—: " + error.message);
    }
    events = events.filter(e => e.doc_key !== docKey);
    $("eventsCount").textContent = String(events.length);
    scheduleEventsRender();
  }

  function renderEventsNow(){
    const box = $("events");
    box.innerHTML = "";

    const from = $("fFrom").value || null;
    const to   = $("fTo").value || null;

    const filtered = (events||[]).filter(e => {
      const d = e.payload?.date;
      if(!d) return true;
      if(from && d < from) return false;
      if(to && d > to) return false;
      return true;
    });

    $("noEvents").style.display = filtered.length ? "none" : "";

    let sumCost=0, sumSales=0, sumGuests=0;

    for(const e of filtered){
      const p = e.payload || {};
      const date = p.date || "-";
      const guests = p.guests ?? null;
      const cost = Number(p.totalCostYen ?? 0);
      const sales = (p.salesYen===null || p.salesYen===undefined) ? null : Number(p.salesYen); // â˜…ç¨æŠœå£²ä¸Š
      const missingEnds = Number(p.missingEnds ?? 0);
      const isComplete = !!p.isComplete;

      if(isComplete){
        sumCost += cost;
        if(sales!==null) sumSales += sales;
        if(guests && guests>0) sumGuests += guests;
      }

      const duration = p.durationMin ? `${p.durationMin}åˆ†` : "â€”";
      const style = p.style==="standing" ? "ç«‹é£Ÿ" : "ç€å¸­";
      const staff = (p.staff||[]).join(" / ") || "â€”";
      const perHead = (p.drinkPricePerHeadYen && p.drinkPricePerHeadYen>0) ? yen(p.drinkPricePerHeadYen) : "â€”";
      const rate = (sales && sales>0) ? (cost/sales) : null;

      const badge = isComplete ? `<span class="badge">ç¢ºå®š</span>` : `<span class="badge warn">æœªç¢ºå®šï¼ˆæœªå…¥åŠ›${missingEnds}ï¼‰</span>`;
      const armed = (armedDeleteEventKey === e.doc_key);
      const delText = armed ? "ã‚‚ã†ä¸€åº¦ã§å®Œå…¨å‰Šé™¤" : "å‰Šé™¤";
      const delClass = armed ? "danger" : "ghost";

      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="itemHeader">
          <div>
            <h3>${escapeHtml(date)}ã€€${guests ? guests+"å" : "äººæ•°â€”"}ã€€${badge}</h3>
            <div class="small">å˜ä¾¡ï¼š<span class="mono">${escapeHtml(perHead)}</span>ï¼ˆç¨è¾¼ï¼‰ / æ™‚é–“ï¼š${escapeHtml(duration)} / å½¢æ…‹ï¼š${escapeHtml(style)} / æ‹…å½“ï¼š${escapeHtml(staff)}</div>
            <div class="small">
              å£²ä¸Šï¼ˆç¨æŠœï¼‰ï¼š<span class="mono">${sales===null ? "â€”" : yen(sales)}</span>
              / åŸä¾¡ï¼š<span class="mono">${yen(cost)}</span>
              / åŸä¾¡ç‡ï¼š<span class="mono">${rate===null ? "â€”" : pct(rate)}</span>
            </div>
            <div class="small mono">key: ${escapeHtml(e.doc_key)}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <span class="badge">updated: ${escapeHtml(e.updated_at||"-")}</span>
            <button data-act="delEvent" data-key="${escapeHtml(e.doc_key)}" class="${delClass}" type="button">${delText}</button>
          </div>
        </div>
        ${armed ? `<div class="small" style="margin-top:8px;color:var(--warn);">âš  7ç§’ä»¥å†…ã«ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨å‰Šé™¤</div>` : ``}
      `;

      el.querySelector('[data-act="delEvent"]').addEventListener("click", async () => {
        if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
        const key = e.doc_key;

        if(armedDeleteEventKey !== key){
          disarmEventDelete();
          armedDeleteEventKey = key;
          armedDeleteEventTimer = setTimeout(() => { disarmEventDelete(); scheduleEventsRender(); }, 7000);
          scheduleEventsRender();
          return;
        }

        disarmEventDelete();
        scheduleEventsRender();
        if(!confirm("ã“ã®å®´ä¼šãƒ‡ãƒ¼ã‚¿ã‚’Supabaseã‹ã‚‰å®Œå…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        await deleteEvent(key);
      });

      box.appendChild(el);
    }

    $("kpiSumCostComplete").textContent = yen(sumCost);
    $("kpiSumSalesComplete").textContent = yen(sumSales);
    $("kpiSumCostRateComplete").textContent = (sumSales>0) ? pct(sumCost/sumSales) : "â€”";
    $("kpiSumGuests").textContent = String(sumGuests);
    $("kpiAvgPerHead").textContent = (sumGuests>0) ? `å¹³å‡ï¼ˆåŸä¾¡/äººï¼‰ ${yen(sumCost/sumGuests)}` : "â€”";
  }

  async function confirmStart(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(!master.items?.length) return alert("å•†å“ãƒã‚¹ã‚¿ãŒç©ºã§ã™ã€‚å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
    if(!$("evDate").value) $("evDate").value = todayISO();

    stage = "end";
    autoFillEndFromStart(false);
    updateStageUI();
    renderProductsFull();
    scheduleKpis();
    markDraftDirty("stage end");

    alert("â‘¥é–‹å§‹ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚â‘¦çµ‚äº†å…¥åŠ›ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚\nâ€»çµ‚äº†ã¯é–‹å§‹ã§è‡ªå‹•å…¥åŠ›æ¸ˆã¿ãªã®ã§ã€å®Ÿæ•°ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚");
  }

  async function backToStart(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(!confirm("çµ‚äº†å…¥åŠ›ã‚’ç ´æ£„ã—ã¦ã€é–‹å§‹å…¥åŠ›ã¸æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) return;
    stage = "start";
    for(const it of (master.items||[])) end10[it.id] = null;
    updateStageUI();
    renderProductsFull();
    scheduleKpis();
    markDraftDirty("stage start");
  }

  function buildEventPayload(){
    const a = calcAgg();
    const guests = parseIntSafe($("evGuests").value);
    const per = parseIntSafe($("evDrinkPrice").value);

    // â˜…ç¨æŠœå£²ä¸Š
    const salesYen = calcNetSalesYen(guests, per);

    const ext = Math.max(0, parseIntSafe($("evExt").value) || 0);
    const durationMin = 90 + 30*ext;

    return {
      version:1,
      date: $("evDate").value || todayISO(),
      guests: guests ?? null,
      drinkPricePerHeadYen: per ?? null, // å…¥åŠ›ã¯ç¨è¾¼ã®ã¾ã¾ä¿æŒ
      salesYen, // ç¨æŠœã§ä¿å­˜
      extensionCount: ext,
      durationMin,
      style: $("evStyle").value || "seated",
      staff: ($("evStaff").value||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0,2),
      totalCostYen: Math.round(a.total),
      usedItemCount: a.usedItemCount,
      missingEnds: a.missingEnds,
      negativeCount: a.negativeCount,
      isComplete: (a.missingEnds===0),
      draftKey: currentDraftKey
    };
  }

  async function finishEvent(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(stage!=="end") return alert("â‘§ã¯â‘¦çµ‚äº†å…¥åŠ›ã®ã‚ã¨ã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    const u = await getUser();
    if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");

    const payload = buildEventPayload();
    if(payload.missingEnds>0){
      if(!confirm(`çµ‚äº†æœªå…¥åŠ›ãŒ ${payload.missingEnds} ä»¶ã‚ã‚Šã¾ã™ã€‚\næœªç¢ºå®šã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    }

    const docKey = crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"");
    const { error } = await sb.from("docs").insert({ user_id:u.id, kind:EVENT_KIND, doc_key:docKey, payload });
    if(error){
      log("finishEvent error", error);
      return alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
    }

    if(currentDraftKey){
      await deleteDraft(currentDraftKey);
    }

    await loadEvents();
    setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šâ€”", "ok");
    alert("â‘§å®´ä¼šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
  }

  // ===== Meta reset (2æ®µéš) =====
  let metaResetArmed = false;
  let metaResetTimer = null;

  function disarmMetaReset(){
    metaResetArmed = false;
    clearTimeout(metaResetTimer);
    $("btnMetaReset").classList.remove("danger","warn");
    $("btnMetaReset").classList.add("ghost");
    $("btnMetaReset").textContent = "â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰";
  }

  function clearMetaOnly(){
    $("evDate").value = todayISO();
    $("evGuests").value = "";
    $("evDrinkPrice").value = "";
    $("evExt").value = "0";
    $("evStyle").value = "seated";
    $("evStaff").value = "";
    updateDurationUI();
    scheduleKpis();
    markDraftDirty("meta reset");
  }

  function onMetaResetClick(){
    if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
    if(stage==="end") return alert("â‘¦çµ‚äº†å…¥åŠ›ä¸­ã¯â‘¢ã‚’ãƒªã‚»ãƒƒãƒˆã§ãã¾ã›ã‚“ã€‚");

    if(!metaResetArmed){
      metaResetArmed = true;
      $("btnMetaReset").classList.remove("ghost");
      $("btnMetaReset").classList.add("warn");
      $("btnMetaReset").textContent = "ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤";
      metaResetTimer = setTimeout(disarmMetaReset, 7000);
      return;
    }

    if(!confirm("â‘¢å®´ä¼šæƒ…å ±ã‚’å‰Šé™¤ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰ã—ã¾ã™ã€‚\nâ€»å•†å“å…¥åŠ›ï¼ˆé–‹å§‹/çµ‚äº†ï¼‰ã¯æ®‹ã‚Šã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
      disarmMetaReset();
      return;
    }
    clearMetaOnly();
    disarmMetaReset();
    alert("â‘¢å®´ä¼šæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
  }

  // ===== Realtimeï¼ˆå…ƒã®ã¾ã¾ï¼‰ =====
  function stopRealtime(){
    if(rtChannel){
      sb.removeChannel(rtChannel);
      rtChannel = null;
    }
    $("rtState").textContent = "OFF";
  }

  function upsertEventRow(row){
    if(!row) return;
    const idx = events.findIndex(e => e.doc_key === row.doc_key);
    if(idx >= 0) events[idx] = row;
    else events.unshift(row);
    $("eventsCount").textContent = String(events.length);
    scheduleEventsRender();
  }
  function deleteEventRow(oldRow){
    const key = oldRow?.doc_key;
    if(!key) return;
    events = events.filter(e => e.doc_key !== key);
    $("eventsCount").textContent = String(events.length);
    scheduleEventsRender();
  }

  function upsertDraftRow(newRow){
    if(!newRow) return;
    const idx = drafts.findIndex(d => d.doc_key === newRow.doc_key);
    if(idx >= 0){
      drafts[idx] = { doc_key:newRow.doc_key, payload:newRow.payload, updated_at:newRow.updated_at };
    }else{
      drafts.unshift({ doc_key:newRow.doc_key, payload:newRow.payload, updated_at:newRow.updated_at });
    }
    drafts.sort((a,b) => String(b.updated_at||"").localeCompare(String(a.updated_at||"")));
    $("draftsCount").textContent = String(drafts.length);
    renderDraftList();
  }

  function deleteDraftRow(oldRow){
    const key = oldRow?.doc_key;
    if(!key) return;
    drafts = drafts.filter(d => d.doc_key !== key);
    $("draftsCount").textContent = String(drafts.length);
    renderDraftList();

    if(key === currentDraftKey){
      alert("ç¾åœ¨ã®ä¸‹æ›¸ããŒä»–ç«¯æœ«ã§å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚åˆ¥ã®ä¸‹æ›¸ãã¸åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚");
      const next = drafts[0]?.doc_key || null;
      if(next) switchToDraft(next);
      else createNewDraft(true);
    }
  }

  async function startRealtime(){
    stopRealtime();
    const u = await getUser();
    if(!u) return;

    rtChannel = sb.channel("docs-rt-s");
    rtChannel.on("postgres_changes", {
      event:"*",
      schema:"public",
      table:"docs",
      filter:`user_id=eq.${u.id}`
    }, async (payload) => {
      $("rtState").textContent = "ON";
      const evType = payload.eventType;
      const n = payload.new || null;
      const o = payload.old || null;

      const kind = n?.kind ?? o?.kind ?? null;
      const key  = n?.doc_key ?? o?.doc_key ?? null;

      if(kind === MASTER_KIND && key === "main" && n?.payload){
        master = n.payload;
        normalizeMaster();
        masterRowEnsured = true;
        initQtyMaps();
        autoFillEndFromStart(false);
        editingMasterId = null;
        renderMaster();
        renderProductsFull();
        scheduleKpis();
        return;
      }

      if(kind === DRAFT_KIND){
        if(evType === "DELETE"){
          deleteDraftRow(o);
          return;
        }

        if(n?.payload){
          upsertDraftRow(n);

          if(key === currentDraftKey){
            draftServerUpdatedAt = n.updated_at || payload.commit_timestamp || draftServerUpdatedAt;

            const remote = n.payload;
            const isOwnEcho = (remote.savedBy === getOrCreateDeviceId()) && (remote.savedAt === draftSavedAt);
            if(isOwnEcho) return;

            const now = Date.now();
            const justEdited = (now - lastLocalEditAt) < REMOTE_APPLY_GUARD_MS;

            if(draftDirty && justEdited){
              showRemoteBanner(`remote savedAt=${remote.savedAt} by=${remote.savedBy}`, remote);
              setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šä»–ç«¯æœ«æ›´æ–°ã‚ã‚Šï¼ˆåæ˜ å¾…ã¡ï¼‰", "run");
              return;
            }

            applyDraftPayload(remote, "ä»–ç«¯æœ«ã‹ã‚‰åæ˜ ");
            setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šä»–ç«¯æœ«æ›´æ–°ã‚’åæ˜ ", "ok");
          }
        }
        return;
      }

      if(kind === EVENT_KIND){
        if(evType === "DELETE") deleteEventRow(o);
        else if(evType === "INSERT" || evType === "UPDATE") upsertEventRow(n);
        return;
      }
    });

    const { error } = await rtChannel.subscribe((status) => { $("rtState").textContent = status; });
    if(error) log("rt subscribe error", error);
  }

  async function reloadAll(){
    const u = await refreshAuthState();
    if(!u) return;

    setMustReload(true);
    setReloadBusy(true, "â‘¡å†èª­ã¿è¾¼ã¿ä¸­â€¦ï¼ˆmaster / drafts / eventsï¼‰");
    setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šâ€”", "run");

    try{
      await Promise.all([ loadMaster(), loadDraftList(), loadEvents() ]);

      let prefer = getActiveDraftKeyFromStorage();
      if(prefer && !drafts.some(d => d.doc_key === prefer)) prefer = null;
      if(!prefer) prefer = drafts[0]?.doc_key || null;

      if(!prefer){
        await createNewDraft(true);
      }else{
        await switchToDraft(prefer);
      }

      await startRealtime();

      setReloadBusy(false, "å®Œäº† âœ… â‘¢ã¸ç§»å‹•ã—ã¾ã™â€¦");
      setMustReload(false);

      setTimeout(() => {
        showTab("banquet");
        scrollToMetaCard();
      }, 150);

      setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šæº–å‚™OKï¼ˆè‡ªå‹•åŒæœŸï¼‰", "ok");
      setAppState("app: ready");
    }catch(e){
      log("reloadAll error", e);
      setReloadBusy(false, "å¤±æ•—: " + (e?.message || e));
      setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šâ€”", "bad");
      showLoginAlert("â‘¡å†èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e?.message || String(e));
      setAppState("app: reload failed");
    }finally{
      autoReloadInProgress = false;
      updateBulkBarUI();
    }
  }

  async function setLoginBusy(on){
    $("btnLogin").disabled = on;
    $("btnLogout").disabled = on;
    $("email").disabled = on;
    $("pw").disabled = on;
  }

  function bindMainButtons(){
    // theme
    on("btnTheme", "click", () => {
      const now = document.documentElement.dataset.theme || "light";
      applyTheme(now === "dark" ? "light" : "dark");
    });

    // â‘¡ retry
    on("btnReloadRetry", "click", () => {
      if(autoReloadInProgress) return;
      autoReloadInProgress = true;
      reloadAll();
    });

    // manual reload
    on("btnReloadNow", "click", async () => {
      const u = await getUser();
      if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
      if(autoReloadInProgress) return;
      setMustReload(true);
      setReloadMsg("æ‰‹å‹•ã§â‘¡å†èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™â€¦");
      autoReloadInProgress = true;
      window.scrollTo({ top:0, behavior:"smooth" });
      setTimeout(reloadAll, 80);
    });

    // login
    on("btnLogin", "click", async () => {
      showLoginAlert("ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™â€¦", null);

      if(!sb){
        showLoginAlert("Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæœªåˆæœŸåŒ–ã§ã™", "SDKãŒèª­ã¿è¾¼ã‚ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆCDNãƒ–ãƒ­ãƒƒã‚¯/é€šä¿¡ï¼‰");
        return;
      }

      const email = $("email").value.trim();
      const password = $("pw").value;
      if(!email || !password){
        showLoginAlert("ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "missing email/password");
        return;
      }

      await setLoginBusy(true);
      try{
        showLoginAlert("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦", null);
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error){
          log("login error", error);
          showLoginAlert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—", error.message || String(error));
          setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šâ€”", "bad");
          return;
        }

        await refreshAuthState();
        showLoginAlert("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ âœ… â‘¡å†èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™â€¦", null);

        setMustReload(true);
        setReloadMsg("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã€‚â‘¡å†èª­ã¿è¾¼ã¿ã‚’è‡ªå‹•é–‹å§‹ã—ã¾ã™â€¦");
        if(!autoReloadInProgress){
          autoReloadInProgress = true;
          setTimeout(reloadAll, 60);
        }
        window.scrollTo({ top:0, behavior:"smooth" });
      }catch(e){
        log("login exception", e);
        showLoginAlert("ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ", e?.message || String(e));
      }finally{
        await setLoginBusy(false);
      }
    });

    // logout
    on("btnLogout", "click", async () => {
      if(!sb) return;
      stopRealtime();
      await sb.auth.signOut();
      setMustReload(true);
      $("authState").textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
      setReloadMsg("â€”");
      setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šâ€”", "bad");
      showLoginAlert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ", null);
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
    });

    // ===== ä¸‹æ›¸ããƒœã‚¿ãƒ³ =====
    let topDeleteArmed = false;
    let topDeleteTimer = null;

    const disarmTopDelete = () => {
      topDeleteArmed = false;
      if(topDeleteTimer) clearTimeout(topDeleteTimer);
      topDeleteTimer = null;
      const b = $("btnDelDraft");
      if(b) b.textContent = "ä¸‹æ›¸ãå‰Šé™¤";
    };

    on("btnNewDraft", "click", async () => {
      if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
      const u = await getUser();
      if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
      disarmTopDelete();
      await createNewDraft(true);
    });

    on("btnDupDraft", "click", async () => {
      if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
      const u = await getUser();
      if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
      if(!currentDraftKey) return alert("è¤‡è£½ã™ã‚‹ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä¸‹æ›¸ãã‚’ä½œã£ã¦ãã ã•ã„ã€‚");
      disarmTopDelete();
      await duplicateDraft(currentDraftKey);
    });

    on("btnDelDraft", "click", async () => {
      if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");
      const u = await getUser();
      if(!u) return alert("å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦");
      if(!currentDraftKey) return alert("å‰Šé™¤ã™ã‚‹ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“ã€‚");

      if(!topDeleteArmed){
        topDeleteArmed = true;
        const b = $("btnDelDraft");
        if(b) b.textContent = "ã‚‚ã†ä¸€åº¦ã§å‰Šé™¤";
        topDeleteTimer = setTimeout(disarmTopDelete, 7000);
        return;
      }

      disarmTopDelete();
      if(!confirm("ç¾åœ¨ã®ä¸‹æ›¸ãã‚’Supabaseã‹ã‚‰å®Œå…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      await deleteDraft(currentDraftKey);
    });

    // local cache clear
    on("btnDraftClearLocal", "click", () => {
      if(!currentDraftKey) return alert("å¯¾è±¡ã®ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      if(!confirm("ã“ã®ç«¯æœ«ã®ãƒ­ãƒ¼ã‚«ãƒ«é€€é¿ï¼ˆå¾©å…ƒç”¨ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nSupabaseå´ã®ä¸‹æ›¸ãã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      clearLocalDraftForKey(currentDraftKey);
      alert("ãƒ­ãƒ¼ã‚«ãƒ«é€€é¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
    });

    // stage segï¼ˆè‡ªç„¶ãªæŒ™å‹•ï¼‰
    on("btnStageStart", "click", () => {
      if(stage === "end") backToStart();
      else $("products")?.scrollIntoView({ behavior:"smooth", block:"start" });
    });
    on("btnStageEnd", "click", () => {
      if(stage === "start") confirmStart();
      else $("products")?.scrollIntoView({ behavior:"smooth", block:"start" });
    });

    // bulk fill
    on("btnFillStartMin", "click", () => {
      const items = master.items || [];
      const hasNonZero = items.some(it => (it.min10||0)>0 && (start10[it.id]||0) > 0);
      if(hasNonZero){
        const overwrite = confirm("é–‹å§‹å…¥åŠ›ã«æ—¢ã«æ•°ãŒå…¥ã£ã¦ã„ã‚‹å•†å“ãŒã‚ã‚Šã¾ã™ã€‚\n\nOKï¼šç›®å®‰ã§ä¸Šæ›¸ã\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼š0ã®ã‚‚ã®ã ã‘ç›®å®‰å…¥åŠ›");
        fillStartByMin(overwrite);
      }else{
        fillStartByMin(true);
      }
    });

    // flow
    on("btnDraftSave", "click", async () => { if(sb) await saveRemoteDraftNow(false, "manual"); });
    on("btnConfirmStart", "click", confirmStart);
    on("btnBackToStart", "click", backToStart);
    on("btnFinishEvent", "click", finishEvent);

    // â‘¥å–ã‚Šæ¶ˆã—ï¼ˆâ‘¢ã‚’ç·¨é›†ã«æˆ»ã™ï¼‰
    on("btnUnlockMeta", "click", backToStart);

    // meta reset
    on("btnMetaReset", "click", onMetaResetClick);

    // remote banner
    on("btnApplyRemote", "click", () => {
      if(!pendingRemoteDraft) return hideRemoteBanner();
      applyDraftPayload(pendingRemoteDraft, "ãƒãƒŠãƒ¼ã‹ã‚‰åæ˜ ");
      setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šä»–ç«¯æœ«æ›´æ–°ã‚’åæ˜ ", "ok");
    });
    on("btnIgnoreRemote", "click", () => {
      hideRemoteBanner();
      setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆï¼ˆä¸Šæ›¸ãæ³¨æ„ï¼‰", "run");
    });

    // filter
    on("btnClearFilter", "click", () => {
      $("fFrom").value = "";
      $("fTo").value = "";
      scheduleEventsRender();
    });
    on("fFrom", "change", scheduleEventsRender);
    on("fTo", "change", scheduleEventsRender);

    // dump
    on("btnDump", "click", () => {
      log("DUMP", { master, currentDraftKey, stage, start10, end10, draftsCount:drafts.length, eventsCount: events.length, draftDirty, lastSyncError });
    });

    // meta changes
    ["evDate","evGuests","evDrinkPrice","evExt","evStyle","evStaff"].forEach(id => {
      on(id, "change", () => {
        updateDurationUI();
        scheduleKpis();
        markDraftDirty("meta");
      });
    });

    // master add/save
    on("btnAddMaster", "click", () => {
      if(mustReload) return alert("â‘¡å†èª­ã¿è¾¼ã¿ãŒå®Œäº†ã™ã‚‹ã¾ã§æ“ä½œã§ãã¾ã›ã‚“ã€‚");

      const name = ($("mName").value || "").trim();
      const unit = ($("mUnit").value || "æœ¬").trim() || "æœ¬";
      const cost = parseNumberSafe($("mCost").value);
      const minN = parseNumberSafe($("mMin").value);
      const min10 = (minN===null || minN<0) ? 0 : Math.max(0, to10(minN));

      if(!name) return alert("å•†å“åã‚’å…¥ã‚Œã¦ãã ã•ã„");
      if(cost===null || cost<0) return alert("ä»•å…¥å˜ä¾¡ãŒä¸æ­£ã§ã™");

      const it = {
        id: crypto.randomUUID ? crypto.randomUUID() : (Date.now()+""),
        name, unit,
        costYen: Math.round(cost),
        min10,
        category: ($("mCat").value || "").trim() || null,
        note: ($("mNote").value || "").trim() || null
      };

      master.items = [it, ...(master.items||[])];

      $("mName").value = "";
      $("mUnit").value = "æœ¬";
      $("mCost").value = "";
      $("mMin").value = "";
      $("mCat").value = "";
      $("mNote").value = "";

      normalizeMaster();
      initQtyMaps();
      autoFillEndFromStart(false);

      editingMasterId = it.id;
      renderMaster();
      renderProductsFull();
      scheduleKpis();
      markDraftDirty("master add");
    });

    on("btnSaveMaster", "click", saveMaster);
  }

  // ===== Boot =====
  async function boot(){
    applyTheme(localStorage.getItem(THEME_KEY) || "light");
    refreshNet();
    window.addEventListener("online", refreshNet);
    window.addEventListener("offline", refreshNet);

    $("deviceId").textContent = getOrCreateDeviceId();
    $("evDate").value = todayISO();
    $("evExt").value = "0";
    updateDurationUI();
    bindTabs();
    bindMainButtons();
    bindProductsDelegationOnce();
    updateStageUI();
    scheduleKpis();
    scheduleEventsRender();
    updateBulkBarUI();

    setMustReload(true);
    setReloadMsg("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚â‘ ã‹ã‚‰ã€‚");
    setSyncState("ä¸‹æ›¸ãåŒæœŸï¼šâ€”", "bad");
    showLoginAlert("èµ·å‹•å®Œäº†ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", null);
    setAppState("app: ui ready");

    // Supabase init
    try{
      const loadedFrom = await ensureSupabaseSdk();
      log("supabase sdk loaded", loadedFrom);
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setAppState("app: supabase ready");
      showLoginAlert("Supabaseæº–å‚™OKã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", null);

      const u = await refreshAuthState();
      if(u && !autoReloadInProgress){
        showLoginAlert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚Šï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼‰â†’â‘¡å†èª­ã¿è¾¼ã¿ã—ã¾ã™", null);
        setReloadMsg("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ã‚Šã€‚â‘¡å†èª­ã¿è¾¼ã¿ã‚’è‡ªå‹•é–‹å§‹ã—ã¾ã™â€¦");
        autoReloadInProgress = true;
        setTimeout(reloadAll, 80);
      }
    }catch(e){
      log("supabase init failed", e);
      showLoginAlert("Supabase SDK ã®èª­ã¿è¾¼ã¿/åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ", e?.message || String(e));
      setAppState("app: supabase failed");
    }
  }

  try{
    boot();
  }catch(e){
    log("boot crash", e);
    showLoginAlert("èµ·å‹•ä¸­ã«è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼", e?.message || String(e));
    setAppState("app: boot failed");
  }
})();
</script>
</body>
</html>
